# 조석-해양 관측소 매칭 시스템

## 📋 개요

조석관측소와 해양관측소를 `marine_observations` 테이블의 실제 데이터 품질 기반으로 자동 매칭하는 시스템입니다.

## 🚀 접속 방법

1. **메인 대시보드 접속**
   - URL: https://mancool.netlify.app/
   - 로그인 필요 (admin-login.html)

2. **조석-해양 매칭 메뉴 선택**
   - 왼쪽 사이드바 → "해양관측소 관리" 섹션
   - "🔗 조석-해양 매칭" 클릭

## 💡 주요 기능

### 1. 조석관측소 선택
- **전체 조석관측소**: 모든 조석관측소(178개)를 한 번에 분석
- **개별 선택**: 특정 조석관측소만 선택하여 분석

### 2. 날짜 범위 지정
- marine_observations 테이블에서 분석할 기간 선택
- observation_time_kst 컬럼으로 필터링
- 권장: 최소 7일 이상의 데이터로 분석

### 3. 자동 데이터 분석
각 해양관측소별로 다음 지표를 자동 분석:

- **전체 레코드 수**: 기간 내 총 데이터 수집 건수
- **유효 데이터 비율**: null이 아닌 유효한 데이터의 비율 (%)
- **평균 수집 주기**: 데이터 수집 간격 (분 단위)
- **데이터 품질 평가**: 우수/보통/불량 자동 판정

### 4. 필드별 매칭 (5개)

| 필드 | 설명 | 용도 |
|------|------|------|
| wt | Water Temperature | 수온 |
| swh | Significant Wave Height | 파고 |
| wd | Wind Direction | 풍향 |
| ws | Wind Speed | 풍속 |
| at | Air Temperature | 기온 |

각 필드별로 상위 2개 후보 관측소 추천

### 5. 추천 알고리즘

다음 우선순위로 자동 정렬:

1. **유효 데이터 비율** (높을수록 좋음)
   - 80% 이상: 우수
   - 50-80%: 보통
   - 50% 미만: 불량

2. **평균 수집 간격** (짧을수록 좋음)
   - 실시간성 반영

3. **거리** (가까울수록 좋음)
   - Haversine 공식으로 계산

## 📝 사용 절차

### Step 1: 매칭 실행

1. 조석관측소 선택 (전체 또는 개별)
2. 분석 기간 지정 (예: 2026-01-10 ~ 2026-01-17)
3. "매칭 실행" 버튼 클릭
4. 데이터 분석 완료 대기

### Step 2: 추천 확인 및 선택

각 조석관측소마다:
- 5개 필드(wt, swh, wd, ws, at)별로 2개 후보 표시
- 데이터 통계 확인:
  - 전체 레코드 수
  - 유효 데이터 비율
  - 평균 수집 주기
  - 데이터 품질
- 원하는 관측소의 "선택" 버튼 클릭

### Step 3: Supabase 업로드

1. 모든 필드의 관측소 선택 완료
2. "tide_abs_region 테이블에 업로드" 버튼 클릭
3. 확인 메시지 체크
4. 업로드 완료 확인

## 🗄️ 데이터베이스 영향

### tide_abs_region 테이블

업데이트되는 컬럼:
```sql
UPDATE tide_abs_region
SET
    wt_STN_ID = '선택한 수온 관측소 ID',
    swh_STN_ID = '선택한 파고 관측소 ID',
    wd_STN_ID = '선택한 풍향 관측소 ID',
    ws_STN_ID = '선택한 풍속 관측소 ID',
    at_STN_ID = '선택한 기온 관측소 ID'
WHERE Code = '조석관측소 코드';
```

### 서비스 반영

업로드 완료 후 즉시 반영:
- `get-ad-weather-data` Edge Function
- 앱 API 호출 시 새로운 매칭 정보 사용

## 📊 매칭 데이터 소스

### 입력 파일

1. **locations_with_addresses.xml**
   - 178개 조석관측소 정보
   - 위도, 경도, 해역 정보 포함

2. **a지점_파고수온제공_2026-01-10_2026-01-17.csv**
   - 파고(swh), 수온(wt) 제공 관측소

3. **b지점_기온풍향풍속제공_2026-01-10_2026-01-17.csv**
   - 기온(at), 풍향(wd), 풍속(ws) 제공 관측소

### 생성 파일

- **station_matching_top10.json**
  - 각 조석관측소별 가까운 해양관측소 10개 목록
  - 거리순 정렬
  - 제공 필드 정보 포함

## 🛠️ 기술 구현

### Python 스크립트 (match_stations.py)

```bash
# 매칭 데이터 생성
python3 match_stations.py
```

- Haversine 공식으로 정확한 거리 계산
- 181개 해양관측소와 178개 조석관측소 매칭
- JSON 출력

### HTML 관리자 페이지

- **위치**: `/tide-marine-station-matcher.html`
- **인증**: 대시보드 로그인 필요
- **Supabase 연동**: 실시간 데이터 분석
- **Pagination**: 1000개 이상 레코드 조회 지원

## ⚠️ 주의사항

1. **분석 기간 선택**
   - 너무 짧은 기간(1-2일)은 부정확할 수 있음
   - 권장: 최소 7일 이상

2. **데이터 품질 확인**
   - 유효 데이터 비율이 50% 미만인 경우 신중히 선택
   - 여러 후보 비교 필요

3. **업로드 전 확인**
   - 선택한 매칭이 올바른지 재확인
   - 업로드 후 즉시 서비스에 반영됨

4. **성능 고려**
   - "전체 조석관측소" 선택 시 시간 소요 (약 5-10분)
   - 개별 선택 권장

## 📱 서비스 영향

### get-ad-weather-data API

```json
{
  "marine_observations": {
    "wt": [{"station_id": "400031", ...}],
    "swh": [{"station_id": "22472", ...}],
    "wd": [{"station_id": "400031", ...}],
    "ws": [{"station_id": "400031", ...}],
    "at": [{"station_id": "400031", ...}]
  }
}
```

각 필드별로 매칭된 관측소 데이터 제공

## 🔍 트러블슈팅

### 문제: 데이터가 로드되지 않음
- Supabase 연결 확인
- abs_fetch_log 테이블 접근 권한 확인
- 브라우저 콘솔에서 에러 확인

### 문제: 추천 관측소가 없음
- 해당 관측소가 해당 필드를 제공하지 않음
- 날짜 범위 내 데이터가 없음
- marine_observations 테이블 데이터 수집 확인

### 문제: 업로드 실패
- tide_abs_region 테이블 접근 권한 확인
- 조석관측소 Code 값 확인
- Supabase 서비스 상태 확인

## 📚 관련 문서

- [API 명세서](./API_get-ad-weather-data_v19.md)
- [해양관측소 데이터 수집 가이드](./ABS_FETCH_LOG_CRON_SETUP.md)
- [데이터베이스 스키마](../schema.sql)
