# 🚨 API 타임존 수정 알림 (2025-12-04)

## 📌 개요

Supabase Edge Functions의 **시간 관련 버그를 수정**했습니다.
클라이언트 앱에서 **시간 표시 관련 로직을 점검**해주세요.

---

## 🔴 긴급: 영향받는 API 응답 데이터

### 1. GET /get-weather-tide-data

**주요 클라이언트 API로, 다음 데이터의 시간 형식이 변경됩니다.**

---

## 📊 수정된 데이터 형식

### ⚠️ 변경 사항 요약표

| 테이블/필드 | 수정 전 (잘못됨) | 수정 후 (올바름) | 차이 | 영향도 |
|------------|------------------|------------------|------|--------|
| **weather_forecasts** | | | | |
| `fcst_datetime_kr` | `2025-12-04T09:00:00Z` | `2025-12-04T09:00:00+09:00` | 타임존 표기 | 🔴 높음 |
| `updated_at_kr` | `2025-12-04T15:00:00Z` | `2025-12-04T15:00:00+09:00` | 타임존 표기 | 🟡 중간 |
| **medium_term_forecasts** | | | | |
| `tm_fc_kr` | `2025-12-04T15:00:00+09:00` | `2025-12-04T06:00:00+09:00` | **9시간 차이** | 🔴 높음 |
| `tm_ef_kr` | `2025-12-04T15:00:00+09:00` | `2025-12-04T06:00:00+09:00` | **9시간 차이** | 🔴 높음 |
| `created_at_kr` | `2025-12-04T18:00:00+09:00` | `2025-12-04T09:00:00+09:00` | **9시간 차이** | 🟡 중간 |
| `updated_at_kr` | `2025-12-04T18:00:00+09:00` | `2025-12-04T09:00:00+09:00` | **9시간 차이** | 🟡 중간 |
| **marine_observations** | | | | |
| `observation_time_utc` | `2026-01-03T21:00:00Z` | `2025-12-03T21:00:00Z` | **1개월 차이** | 🔴 높음 |

---

## 🔍 상세 변경 내용

### 1. weather_forecasts (단기예보 데이터)

#### 변경 필드: `fcst_datetime_kr`, `updated_at_kr`

**문제**: "Z" (UTC) 표기로 인한 클라이언트 오해

```json
// ❌ 수정 전 (2025-12-04 이전)
{
  "fcst_datetime": "2025-12-03T21:00:00.000Z",
  "fcst_datetime_kr": "2025-12-04T09:00:00.000Z",  // ← Z 표기!
  "updated_at_kr": "2025-12-04T15:30:00.000Z"       // ← Z 표기!
}

// ✅ 수정 후 (2025-12-04 이후)
{
  "fcst_datetime": "2025-12-03T21:00:00.000Z",
  "fcst_datetime_kr": "2025-12-04T09:00:00+09:00",  // ← +09:00 표기
  "updated_at_kr": "2025-12-04T15:30:00+09:00"       // ← +09:00 표기
}
```

**클라이언트 영향**:
```javascript
// ❌ 수정 전: Z를 UTC로 해석하면
new Date("2025-12-04T09:00:00Z")
  .toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})
// 출력: "2025-12-04 18:00:00" (9시간 늦음!)

// ✅ 수정 후: +09:00으로 정확히 해석
new Date("2025-12-04T09:00:00+09:00")
  .toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})
// 출력: "2025-12-04 09:00:00" (정확함!)
```

---

### 2. medium_term_forecasts (중기예보 데이터)

#### 변경 필드: `tm_fc_kr`, `tm_ef_kr`, `created_at_kr`, `updated_at_kr`

**문제**: KST 시간에 9시간이 중복 추가됨

```json
// ❌ 수정 전 (2025-12-04 이전)
{
  "tm_ef": "2025-12-04T06:00:00Z",                // UTC (우연히 맞음)
  "tm_ef_kr": "2025-12-04T15:00:00+09:00",        // ← 9시간 늦음!
  "tm_fc_kr": "2025-12-04T15:00:00+09:00",        // ← 9시간 늦음!
  "created_at_kr": "2025-12-04T18:30:00+09:00"    // ← 9시간 늦음!
}

// ✅ 수정 후 (2025-12-04 이후)
{
  "tm_ef": "2025-12-03T21:00:00Z",                // UTC (정확함)
  "tm_ef_kr": "2025-12-04T06:00:00+09:00",        // ← 원본 시간
  "tm_fc_kr": "2025-12-04T06:00:00+09:00",        // ← 원본 시간
  "created_at_kr": "2025-12-04T09:30:00+09:00"    // ← 실제 시간
}
```

**클라이언트 영향**:
```javascript
// ❌ 수정 전: 9시간 차이
"예보 시각: 15:00"  // 실제는 06:00이어야 함

// ✅ 수정 후: 정확함
"예보 시각: 06:00"  // 정확함!
```

---

### 3. marine_observations (해양 관측 데이터)

#### 변경 필드: `observation_time_utc`

**문제**: UTC 시간이 1개월 미래로 저장됨

```json
// ❌ 수정 전 (2025-12-04 이전)
{
  "observation_time_kst": "202512040600",         // KST 06:00 (정확함)
  "observation_time_utc": "2026-01-03T21:00:00Z"  // ← 1개월 미래!
}

// ✅ 수정 후 (2025-12-04 이후)
{
  "observation_time_kst": "202512040600",         // KST 06:00 (정확함)
  "observation_time_utc": "2025-12-03T21:00:00Z"  // ← 정확한 UTC
}
```

---

## 🔧 클라이언트 점검 사항

### 1. ✅ 즉시 점검 필요: 시간 파싱 로직

#### fcst_datetime_kr, tm_ef_kr 등 _kr 필드

```javascript
// ⚠️ 기존 코드가 이렇게 되어 있다면 수정 필요
const time = data.fcst_datetime_kr;  // "2025-12-04T09:00:00Z"
const date = new Date(time);  // Z를 UTC로 해석 → 18:00으로 표시됨

// ✅ 권장: ISO 8601 파서 사용 (타임존 자동 인식)
const date = new Date(time);  // "+09:00" 자동 인식
```

#### 체크리스트
- [ ] `fcst_datetime_kr` 표시 확인
- [ ] `tm_ef_kr`, `tm_fc_kr` 표시 확인
- [ ] 중기예보 시각 표시 (9시간 차이 확인)
- [ ] 해양 관측 데이터 날짜 필터링 (1개월 차이 확인)

---

### 2. ✅ 날짜 비교 로직 점검

```javascript
// ❌ 문자열 직접 비교 (위험)
if (data.tm_ef_kr > "2025-12-07T00:00:00") { ... }

// ✅ Date 객체로 변환 후 비교 (안전)
const date1 = new Date(data.tm_ef_kr);
const date2 = new Date("2025-12-07T00:00:00+09:00");
if (date1 > date2) { ... }
```

---

### 3. ✅ 시간대 표시 로직 점검

```javascript
// ❌ 하드코딩된 9시간 추가/제거
const kstTime = new Date(utcTime).getTime() + 9 * 60 * 60 * 1000;

// ✅ toLocaleString 사용 (자동 타임존 처리)
const kstTime = new Date(data.fcst_datetime_kr)
  .toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'});
```

---

## 📅 마이그레이션 일정

### 2025-12-04 (오늘)
- ✅ 서버 코드 수정 완료
- ⏳ 데이터 갱신 예정 (함수 재실행)

### 클라이언트 대응
1. **즉시**: 앱에서 시간 표시 점검
2. **데이터 갱신 후**: 실제 데이터로 재검증
3. **배포 전**: QA 테스트

---

## 🧪 테스트 가이드

### 1. 단기예보 시간 확인

```bash
# API 호출
GET /get-weather-tide-data?code=DT_0001&date=2025-12-04

# 응답 확인
{
  "weather_forecasts": [
    {
      "fcst_datetime_kr": "2025-12-04T09:00:00+09:00",  // ← +09:00 확인
      ...
    }
  ]
}
```

**확인 사항**:
- [ ] `fcst_datetime_kr`가 `+09:00`로 끝나는가?
- [ ] 앱에 표시되는 시간이 정확한가?

### 2. 중기예보 시간 확인

```bash
# API 호출
GET /get-weather-tide-data?code=DT_0001&date=2025-12-04

# 응답 확인
{
  "marine": [
    {
      "tm_ef_kr": "2025-12-07T06:00:00+09:00",  // ← 06:00 확인 (15:00 아님!)
      ...
    }
  ]
}
```

**확인 사항**:
- [ ] `tm_ef_kr` 시간이 기존보다 9시간 이른가?
- [ ] 예보 시각 표시가 정확한가?

### 3. 해양 관측 데이터 확인

```bash
# API 호출
GET /get-weather-tide-data?code=DT_0001&date=2025-12-04

# 응답 확인
{
  "marine_observations": {
    "a": [
      {
        "observation_time_kst": "202512040600",
        "observation_time_utc": "2025-12-03T21:00:00Z"  // ← 2026년 아님!
      }
    ]
  }
}
```

**확인 사항**:
- [ ] `observation_time_utc`의 연/월이 정확한가?
- [ ] 데이터 필터링이 정상 작동하는가?

---

## 🆘 문제 발생 시

### 현상: 시간이 9시간 늦게 표시됨

**원인**: 클라이언트가 `+09:00`를 처리하지 못함

**해결**:
```javascript
// ISO 8601 파서 사용 (대부분 자동 지원)
const date = new Date(timeString);

// 또는 moment.js / day.js 사용
const date = dayjs(timeString);
```

### 현상: 중기예보 시간이 기존과 다름

**원인**: 기존 데이터가 9시간 늦었음 (버그)

**해결**: 정상입니다. 새로운 시간이 정확합니다.

### 현상: 해양 관측 데이터를 찾을 수 없음

**원인**: 날짜 필터가 1개월 차이로 동작함

**해결**:
1. 데이터 갱신 대기
2. 또는 필터 로직 재확인

---

## 📞 연락처

**질문/이슈 발생 시**:
- GitHub Issues: [supabase_mcp_project/issues](https://github.com/anthropics/supabase_mcp_project/issues)
- 상세 기술 문서: `docs/TIMEZONE_BUGFIX_2025-12-04.md`

---

## 📎 참고 자료

### ISO 8601 타임존 표기
- `Z`: UTC 기준 (예: `2025-12-04T00:00:00Z`)
- `+09:00`: KST (UTC+9) (예: `2025-12-04T09:00:00+09:00`)

### JavaScript Date 파싱
```javascript
// ✅ 자동 타임존 인식
new Date("2025-12-04T09:00:00+09:00")
new Date("2025-12-04T09:00:00Z")

// ❌ 로컬 타임존으로 해석 (위험)
new Date("2025-12-04 09:00:00")
```

---

**작성일**: 2025-12-04
**버전**: 1.0
**작성자**: Backend Team
