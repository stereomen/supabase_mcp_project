// supabase/functions/_shared/firebase-remote-config.ts
// Firebase Remote Config에서 설정값을 가져오는 헬퍼 함수

interface RemoteConfigParameter {
  defaultValue?: {
    value?: string;
    useInAppDefault?: boolean;
  };
  conditionalValues?: {
    [key: string]: {
      value: string;
    };
  };
  description?: string;
  valueType?: 'STRING' | 'BOOLEAN' | 'NUMBER' | 'JSON';
}

interface RemoteConfigTemplate {
  parameters?: {
    [key: string]: RemoteConfigParameter;
  };
  parameterGroups?: {
    [key: string]: {
      description?: string;
      parameters: {
        [key: string]: RemoteConfigParameter;
      };
    };
  };
  etag?: string;
}

// Firebase Service Account에서 JWT 토큰 생성
async function generateJWT(): Promise<string> {
  const serviceAccountKey = Deno.env.get('FIREBASE_SERVICE_ACCOUNT_KEY');
  if (!serviceAccountKey) {
    throw new Error('FIREBASE_SERVICE_ACCOUNT_KEY 환경변수가 설정되지 않았습니다.');
  }

  const serviceAccount = JSON.parse(serviceAccountKey);
  const now = Math.floor(Date.now() / 1000);

  const payload = {
    iss: serviceAccount.client_email,
    scope: 'https://www.googleapis.com/auth/firebase.remoteconfig',
    aud: 'https://oauth2.googleapis.com/token',
    exp: now + 3600,
    iat: now,
  };

  const header = {
    alg: 'RS256',
    typ: 'JWT',
    kid: serviceAccount.private_key_id,
  };

  const encoder = new TextEncoder();
  const headerB64 = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
  const payloadB64 = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

  const data = encoder.encode(`${headerB64}.${payloadB64}`);

  // PEM 형식의 private key를 처리
  const privateKeyPem = serviceAccount.private_key.replace(/\\n/g, '\n');
  const pemHeader = '-----BEGIN PRIVATE KEY-----';
  const pemFooter = '-----END PRIVATE KEY-----';
  const pemContents = privateKeyPem.replace(pemHeader, '').replace(pemFooter, '').replace(/\s/g, '');
  const binaryKey = Uint8Array.from(atob(pemContents), c => c.charCodeAt(0));

  const cryptoKey = await crypto.subtle.importKey(
    'pkcs8',
    binaryKey.buffer,
    { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
    false,
    ['sign']
  );

  const signature = await crypto.subtle.sign('RSASSA-PKCS1-v1_5', cryptoKey, data);
  const signatureB64 = btoa(String.fromCharCode(...new Uint8Array(signature)))
    .replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

  return `${headerB64}.${payloadB64}.${signatureB64}`;
}

// OAuth 2.0 액세스 토큰 획득
async function getAccessToken(): Promise<string> {
  const jwt = await generateJWT();

  const response = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new URLSearchParams({
      grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
      assertion: jwt,
    }),
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error('토큰 획득 실패:', response.status, errorText);
    throw new Error(`토큰 획득 실패: ${response.status}`);
  }

  const tokenData = await response.json();
  return tokenData.access_token;
}

// Remote Config 템플릿 조회
async function getRemoteConfigTemplate(projectId: string): Promise<RemoteConfigTemplate> {
  const accessToken = await getAccessToken();

  const response = await fetch(
    `https://firebaseremoteconfig.googleapis.com/v1/projects/${projectId}/remoteConfig`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json; UTF-8',
      },
    }
  );

  if (!response.ok) {
    const errorText = await response.text();
    console.error('Remote Config 조회 실패:', response.status, errorText);
    throw new Error(`Remote Config 조회 실패: ${response.status}`);
  }

  return await response.json();
}

/**
 * Firebase Remote Config에서 특정 매개변수의 값을 가져옵니다
 * @param parameterKey - 가져올 매개변수 키
 * @param defaultValue - Remote Config에서 값을 찾지 못했을 때 반환할 기본값
 * @param projectId - Firebase 프로젝트 ID (기본값: 환경변수 FIREBASE_PROJECT_ID)
 * @returns 매개변수 값 또는 기본값
 */
export async function getRemoteConfigValue(
  parameterKey: string,
  defaultValue: string,
  projectId?: string
): Promise<string> {
  try {
    const firebaseProjectId = projectId || Deno.env.get('FIREBASE_PROJECT_ID') || 'mancooltime-83e29';

    const config = await getRemoteConfigTemplate(firebaseProjectId);

    // parameters에서 직접 찾기
    if (config.parameters && config.parameters[parameterKey]) {
      return config.parameters[parameterKey].defaultValue?.value || defaultValue;
    }

    // parameterGroups에서 찾기
    if (config.parameterGroups) {
      for (const group of Object.values(config.parameterGroups)) {
        if (group.parameters && group.parameters[parameterKey]) {
          return group.parameters[parameterKey].defaultValue?.value || defaultValue;
        }
      }
    }

    console.log(`[WARN] Remote Config parameter '${parameterKey}' not found, using default: ${defaultValue}`);
    return defaultValue;

  } catch (error) {
    console.error(`[ERROR] Failed to fetch Remote Config for '${parameterKey}':`, error);
    console.log(`[FALLBACK] Using default value: ${defaultValue}`);
    return defaultValue;
  }
}

/**
 * Firebase Remote Config에서 여러 매개변수의 값을 한 번에 가져옵니다
 * @param parameters - {키: 기본값} 형태의 객체
 * @param projectId - Firebase 프로젝트 ID (기본값: 환경변수 FIREBASE_PROJECT_ID)
 * @returns {키: 값} 형태의 객체
 */
export async function getRemoteConfigValues(
  parameters: Record<string, string>,
  projectId?: string
): Promise<Record<string, string>> {
  try {
    const firebaseProjectId = projectId || Deno.env.get('FIREBASE_PROJECT_ID') || 'mancooltime-83e29';

    const config = await getRemoteConfigTemplate(firebaseProjectId);
    const result: Record<string, string> = {};

    for (const [key, defaultValue] of Object.entries(parameters)) {
      // parameters에서 직접 찾기
      if (config.parameters && config.parameters[key]) {
        result[key] = config.parameters[key].defaultValue?.value || defaultValue;
        continue;
      }

      // parameterGroups에서 찾기
      let found = false;
      if (config.parameterGroups) {
        for (const group of Object.values(config.parameterGroups)) {
          if (group.parameters && group.parameters[key]) {
            result[key] = group.parameters[key].defaultValue?.value || defaultValue;
            found = true;
            break;
          }
        }
      }

      if (!found) {
        console.log(`[WARN] Remote Config parameter '${key}' not found, using default: ${defaultValue}`);
        result[key] = defaultValue;
      }
    }

    return result;

  } catch (error) {
    console.error('[ERROR] Failed to fetch Remote Config:', error);
    console.log('[FALLBACK] Using all default values');
    return parameters;
  }
}
