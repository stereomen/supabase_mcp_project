<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì§€ì‚¬í•­ ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .back-button {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }
        .content {
            padding: 30px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .tab:hover {
            background: #f5f5f5;
        }
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-danger {
            background: #dc3545;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #667eea;
            color: white;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
        }
        .badge.pinned {
            background: #ffc107;
            color: #000;
        }
        .actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        .notice-content {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            color: #333;
        }
        .close-btn {
            background: none;
            color: #999;
            font-size: 24px;
            padding: 0;
            cursor: pointer;
        }
        .close-btn:hover {
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .image-upload-area {
            margin-top: 10px;
        }
        .image-preview {
            margin-top: 10px;
            position: relative;
        }
        .image-preview img {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .remove-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }
        .remove-image-btn:hover {
            background: rgba(220, 53, 69, 1);
        }
        .notice-image-thumb {
            max-width: 80px;
            max-height: 60px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-button">â† í™ˆìœ¼ë¡œ</a>
            <h1>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h1>
            <p>ì•± ì‚¬ìš©ìë¥¼ ìœ„í•œ ê³µì§€ì‚¬í•­ì„ ì‘ì„±í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>

        <div class="content">
            <!-- íƒ­ ë©”ë‰´ -->
            <div class="tabs">
                <div class="tab active" onclick="switchTab('list')">ê³µì§€ì‚¬í•­ ëª©ë¡</div>
                <div class="tab" onclick="switchTab('create')">ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</div>
            </div>

            <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ íƒ­ -->
            <div id="listTab" class="tab-content active">
                <div class="section">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>ê³µì§€ì‚¬í•­ ëª©ë¡</h2>
                        <button onclick="loadNoticeList()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                    <div id="noticeListContainer">
                        <div class="loading">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„± íƒ­ -->
            <div id="createTab" class="tab-content">
                <div class="section">
                    <h2>ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h2>
                    <div id="createMessage"></div>
                    <form id="createForm" onsubmit="createNotice(event)">
                        <div class="form-group">
                            <label for="title">ì œëª© *</label>
                            <input type="text" id="title" required>
                        </div>
                        <div class="form-group">
                            <label for="content">ë‚´ìš©</label>
                            <textarea id="content"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="author">ì‘ì„±ì</label>
                            <input type="text" id="author" value="Admin">
                        </div>
                        <div class="form-group">
                            <label for="imageFile">ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</label>
                            <input type="file" id="imageFile" accept="image/*" onchange="previewImage(event, 'create')">
                            <div id="imagePreviewCreate" class="image-preview"></div>
                        </div>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="isPinned">
                            <label for="isPinned" style="margin: 0;">ğŸ“Œ ìƒë‹¨ ê³ ì •</label>
                        </div>
                        <button type="submit">ê³µì§€ì‚¬í•­ ë“±ë¡</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ê³µì§€ì‚¬í•­ ìˆ˜ì •</h2>
                <button class="close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <div id="editMessage"></div>
            <form id="editForm" onsubmit="updateNotice(event)">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label for="editTitle">ì œëª© *</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label for="editContent">ë‚´ìš©</label>
                    <textarea id="editContent"></textarea>
                </div>
                <div class="form-group">
                    <label for="editAuthor">ì‘ì„±ì</label>
                    <input type="text" id="editAuthor">
                </div>
                <div class="form-group">
                    <label for="editImageFile">ì´ë¯¸ì§€ (ì„ íƒì‚¬í•­)</label>
                    <input type="file" id="editImageFile" accept="image/*" onchange="previewImage(event, 'edit')">
                    <input type="hidden" id="editImageUrl">
                    <div id="imagePreviewEdit" class="image-preview"></div>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="editIsPinned">
                    <label for="editIsPinned" style="margin: 0;">ğŸ“Œ ìƒë‹¨ ê³ ì •</label>
                </div>
                <div class="button-group">
                    <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
                    <button type="button" class="btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Supabase ì„¤ì • (ì¸ë¼ì¸) -->
    <script>
    const SUPABASE_CONFIG = {
        url: 'https://iwpgvdtfpwazzfeniusk.supabase.co',
        anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3cGd2ZHRmcHdhenpmZW5pdXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNzEzOTQsImV4cCI6MjA2NjY0NzM5NH0.d0pjIvnOdPGbc_-cfqRNu9yOIutyO1eex848k1yNZJE'
    };
    </script>

    <!-- ê´€ë¦¬ì ì¸ì¦ ì²´í¬ -->
    <script src="_shared/auth-check.js"></script>

    <script>
        const SUPABASE_URL = SUPABASE_CONFIG.url;
        const ANON_KEY = SUPABASE_CONFIG.anonKey;

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        let supabaseClient;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, ANON_KEY);
            } else {
                console.error('Supabase library not loaded');
            }
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        let uploadedImageUrl = null; // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL
        let editUploadedImageUrl = null; // ìˆ˜ì • ì‹œ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ URL

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
        function previewImage(event, mode) {
            const file = event.target.files[0];
            if (!file) return;

            const previewDiv = mode === 'create' ?
                document.getElementById('imagePreviewCreate') :
                document.getElementById('imagePreviewEdit');

            const reader = new FileReader();
            reader.onload = function(e) {
                previewDiv.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="${e.target.result}" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                        <button type="button" class="remove-image-btn" onclick="removeImagePreview('${mode}')">Ã—</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì œê±°
        function removeImagePreview(mode) {
            if (mode === 'create') {
                document.getElementById('imageFile').value = '';
                document.getElementById('imagePreviewCreate').innerHTML = '';
                uploadedImageUrl = null;
            } else {
                document.getElementById('editImageFile').value = '';
                document.getElementById('imagePreviewEdit').innerHTML = '';
                editUploadedImageUrl = null;
            }
        }

        // Storageì— ì´ë¯¸ì§€ ì—…ë¡œë“œ
        async function uploadImageToStorage(file) {
            if (!file) return null;

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `notice_${Date.now()}.${fileExt}`;
                const filePath = `notices/${fileName}`;

                console.log('Uploading image:', filePath);

                const { data, error } = await supabaseClient.storage
                    .from('ad-images')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error('Upload error:', error);
                    throw error;
                }

                // Public URL ìƒì„±
                const { data: urlData } = supabaseClient.storage
                    .from('ad-images')
                    .getPublicUrl(filePath);

                console.log('Upload success:', urlData.publicUrl);
                return urlData.publicUrl;
            } catch (error) {
                console.error('Image upload failed:', error);
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                return null;
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            if (tabName === 'list') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('listTab').classList.add('active');
                loadNoticeList();
            } else if (tabName === 'create') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('createTab').classList.add('active');
            }
        }

        // ê³µì§€ì‚¬í•­ ëª©ë¡ ë¡œë“œ
        async function loadNoticeList() {
            const container = document.getElementById('noticeListContainer');
            container.innerHTML = '<div class="loading">ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/manage-notice-posts`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'list' })
                });

                const result = await response.json();

                if (result.success) {
                    if (result.data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }

                    let tableHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th>ì œëª©</th>
                                    <th style="width: 250px;">ë‚´ìš©</th>
                                    <th style="width: 100px;">ì´ë¯¸ì§€</th>
                                    <th style="width: 100px;">ì‘ì„±ì</th>
                                    <th style="width: 150px;">ì‘ì„±ì¼</th>
                                    <th style="width: 150px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    result.data.forEach(notice => {
                        const createdAt = new Date(notice.created_at).toLocaleString('ko-KR');
                        const pinnedBadge = notice.is_pinned ? '<span class="badge pinned">ğŸ“Œ ê³ ì •</span> ' : '';
                        const imageThumb = notice.image_url ?
                            `<img src="${notice.image_url}" class="notice-image-thumb" onclick="window.open('${notice.image_url}', '_blank')" title="í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°">` :
                            '-';

                        tableHtml += `
                            <tr>
                                <td>${notice.id}</td>
                                <td>${pinnedBadge}${escapeHtml(notice.title)}</td>
                                <td class="notice-content">${escapeHtml(notice.content)}</td>
                                <td>${imageThumb}</td>
                                <td>${escapeHtml(notice.author || 'Admin')}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn-small" onclick="openEditModal(${notice.id})">ìˆ˜ì •</button>
                                        <button class="btn-small btn-danger" onclick="deleteNotice(${notice.id})">ì‚­ì œ</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });

                    tableHtml += `
                            </tbody>
                        </table>
                    `;

                    container.innerHTML = tableHtml;
                } else {
                    container.innerHTML = `<div class="message error">${result.error || 'ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
                }
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                container.innerHTML = `<div class="message error">ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±
        async function createNotice(event) {
            event.preventDefault();

            const messageDiv = document.getElementById('createMessage');
            messageDiv.innerHTML = '<div class="loading">ë“±ë¡ ì¤‘...</div>';

            try {
                // ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìˆëŠ” ê²½ìš°)
                const imageFile = document.getElementById('imageFile').files[0];
                let imageUrl = null;

                if (imageFile) {
                    messageDiv.innerHTML = '<div class="loading">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</div>';
                    imageUrl = await uploadImageToStorage(imageFile);
                    if (!imageUrl) {
                        messageDiv.innerHTML = '<div class="message error">ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                }

                const data = {
                    title: document.getElementById('title').value,
                    content: document.getElementById('content').value,
                    author: document.getElementById('author').value || 'Admin',
                    is_pinned: document.getElementById('isPinned').checked,
                    image_url: imageUrl
                };

                messageDiv.innerHTML = '<div class="loading">ë“±ë¡ ì¤‘...</div>';

                const response = await fetch(`${SUPABASE_URL}/functions/v1/manage-notice-posts`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'create', data })
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '<div class="message success">ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                    document.getElementById('createForm').reset();
                    document.getElementById('imagePreviewCreate').innerHTML = '';
                    uploadedImageUrl = null;
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                        switchTab('list');
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="message error">${result.error || 'ë“±ë¡ ì‹¤íŒ¨'}</div>`;
                }
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ë“±ë¡ ì˜¤ë¥˜:', error);
                messageDiv.innerHTML = `<div class="message error">ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        async function openEditModal(id) {
            const modal = document.getElementById('editModal');
            modal.classList.add('active');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/manage-notice-posts`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'get', id })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('editId').value = result.data.id;
                    document.getElementById('editTitle').value = result.data.title;
                    document.getElementById('editContent').value = result.data.content;
                    document.getElementById('editAuthor').value = result.data.author || 'Admin';
                    document.getElementById('editIsPinned').checked = result.data.is_pinned || false;
                    document.getElementById('editImageUrl').value = result.data.image_url || '';

                    // ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ
                    const previewDiv = document.getElementById('imagePreviewEdit');
                    if (result.data.image_url) {
                        previewDiv.innerHTML = `
                            <div style="position: relative; display: inline-block;">
                                <img src="${result.data.image_url}" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid #ddd;">
                                <button type="button" class="remove-image-btn" onclick="removeImagePreview('edit')">Ã—</button>
                            </div>
                        `;
                    } else {
                        previewDiv.innerHTML = '';
                    }
                } else {
                    alert('ê³µì§€ì‚¬í•­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    closeEditModal();
                }
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error.message);
                closeEditModal();
            }
        }

        // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editMessage').innerHTML = '';
        }

        // ê³µì§€ì‚¬í•­ ìˆ˜ì •
        async function updateNotice(event) {
            event.preventDefault();

            const messageDiv = document.getElementById('editMessage');
            messageDiv.innerHTML = '<div class="loading">ìˆ˜ì • ì¤‘...</div>';

            try {
                const id = parseInt(document.getElementById('editId').value);

                // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ (íŒŒì¼ì´ ì„ íƒëœ ê²½ìš°)
                const imageFile = document.getElementById('editImageFile').files[0];
                let imageUrl = document.getElementById('editImageUrl').value; // ê¸°ì¡´ ì´ë¯¸ì§€ URL

                if (imageFile) {
                    messageDiv.innerHTML = '<div class="loading">ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...</div>';
                    const newImageUrl = await uploadImageToStorage(imageFile);
                    if (!newImageUrl) {
                        messageDiv.innerHTML = '<div class="message error">ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    imageUrl = newImageUrl;
                }

                const data = {
                    title: document.getElementById('editTitle').value,
                    content: document.getElementById('editContent').value,
                    author: document.getElementById('editAuthor').value,
                    is_pinned: document.getElementById('editIsPinned').checked,
                    image_url: imageUrl
                };

                messageDiv.innerHTML = '<div class="loading">ìˆ˜ì • ì¤‘...</div>';

                const response = await fetch(`${SUPABASE_URL}/functions/v1/manage-notice-posts`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'update', id, data })
                });

                const result = await response.json();

                if (result.success) {
                    messageDiv.innerHTML = '<div class="message success">ê³µì§€ì‚¬í•­ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                    setTimeout(() => {
                        closeEditModal();
                        loadNoticeList();
                    }, 1500);
                } else {
                    messageDiv.innerHTML = `<div class="message error">${result.error || 'ìˆ˜ì • ì‹¤íŒ¨'}</div>`;
                }
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì˜¤ë¥˜:', error);
                messageDiv.innerHTML = `<div class="message error">ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }

        // ê³µì§€ì‚¬í•­ ì‚­ì œ
        async function deleteNotice(id) {
            if (!confirm('ì •ë§ ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/manage-notice-posts`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ action: 'delete', id })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadNoticeList();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ' + error.message);
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ í‘œì‹œ
        window.addEventListener('load', () => {
            loadNoticeList();
        });

        // iframe ì•ˆì—ì„œ ë¡œë“œë  ë•Œ í—¤ë” ìˆ¨ê¸°ê¸°
        if (window.self !== window.top) {
            const header = document.querySelector('.header');
            if (header) {
                header.style.display = 'none';
            }
            const container = document.querySelector('.container');
            if (container) {
                container.style.borderRadius = '0';
                container.style.boxShadow = 'none';
            }
            document.body.style.background = 'white';
            document.body.style.padding = '0';
        }
    </script>
</body>
</html>
