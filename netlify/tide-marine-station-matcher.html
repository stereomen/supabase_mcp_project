<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ì„ê´€ì¸¡ì†Œ - í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        select, input[type="date"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            display: none;
        }

        .station-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .station-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .station-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .station-info {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .field-section {
            margin-bottom: 20px;
        }

        .field-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .recommendation-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .recommendation-card.selected {
            background: #e8f4ff;
            border-left-color: #11998e;
        }

        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rec-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .rec-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .rec-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .stat-label {
            color: #888;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .stat-value {
            color: #333;
            font-weight: 600;
        }

        .select-btn {
            padding: 6px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: #5568d3;
        }

        .select-btn.selected {
            background: #11998e;
        }

        .upload-section {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        #previewTable {
            font-size: 13px;
        }

        #previewTable th {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        #previewTable tr:hover {
            background: #f8f9fa;
        }

        .summary {
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e8f4ff;
            color: #0066cc;
            border-left: 4px solid #0066cc;
        }

        .alert-success {
            background: #e8f8f5;
            color: #00a67d;
            border-left: 4px solid #00a67d;
        }

        .alert-error {
            background: #ffe8e8;
            color: #cc0000;
            border-left: 4px solid #cc0000;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
            transition: gap 0.2s;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .back-button:hover {
            gap: 12px;
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    <div class="container">
        <h1>ğŸŒŠ ì¡°ì„ê´€ì¸¡ì†Œ - í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ê´€ë¦¬</h1>
        <p class="subtitle">marine_observations ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ìœ íš¨í•œ í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ë§¤ì¹­í•©ë‹ˆë‹¤</p>

        <div class="control-panel">
            <div class="form-row">
                <div class="form-group">
                    <label for="tideStationSelect">ì¡°ì„ê´€ì¸¡ì†Œ ì„ íƒ (Ctrl/Cmdë¡œ ë‹¤ì¤‘ ì„ íƒ)</label>
                    <select id="tideStationSelect" multiple size="8" style="width: 100%;">
                        <option value="all">ì „ì²´ ì¡°ì„ê´€ì¸¡ì†Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="analyzeAndMatch()">ë§¤ì¹­ ì‹¤í–‰</button>
                <button class="btn" onclick="showNearestStationsPopup()" style="background: #28a745; color: white;">ğŸ“ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ë³´ê¸°</button>
            </div>
        </div>

        <div id="nearestStationsSection" style="display: none; margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0 0 15px 0; color: #667eea;">ğŸ“ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ (ê±°ë¦¬ìˆœ ìƒìœ„ 5ê°œ)</h3>
            <div id="nearestStationsList"></div>
        </div>

        <div id="loadingSpinner">
            <div class="spinner"></div>
            <p>marine_observations ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        </div>

        <div id="resultsContainer" class="results-container"></div>

        <div id="previewSection" class="upload-section" style="display: none;">
            <h3>ğŸ“‹ ë§¤ì¹­ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (tide_abs_region í…Œì´ë¸”)</h3>
            <p style="color: #666; margin: 10px 0;">ğŸ’¡ í‘œì˜ ê°’ì„ í´ë¦­í•˜ë©´ ì§ì ‘ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì—…ë¡œë“œí•˜ë©´ ë³€ê²½ëœ ê°’ì´ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
            <div id="previewSummary" class="summary"></div>
            <div style="overflow-x: auto; margin: 20px 0;">
                <table id="previewTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 0.85em;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th rowspan="2" style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">Code</th>
                            <th rowspan="2" style="padding: 8px; border: 1px solid #ddd; vertical-align: middle;">Name</th>
                            <th colspan="4" style="padding: 8px; border: 1px solid #ddd; background: #5e73d8;">ìˆ˜ì˜¨(wt)</th>
                            <th colspan="4" style="padding: 8px; border: 1px solid #ddd; background: #5e73d8;">íŒŒê³ (swh)</th>
                            <th colspan="4" style="padding: 8px; border: 1px solid #ddd; background: #5e73d8;">í’í–¥(wd)</th>
                            <th colspan="4" style="padding: 8px; border: 1px solid #ddd; background: #5e73d8;">í’ì†(ws)</th>
                            <th colspan="4" style="padding: 8px; border: 1px solid #ddd; background: #5e73d8;">ê¸°ì˜¨(at)</th>
                        </tr>
                        <tr>
                            <!-- wt -->
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">STN_ID</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ìœ„ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ê²½ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ì§€ì—­ëª…</th>
                            <!-- swh -->
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">STN_ID</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ìœ„ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ê²½ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ì§€ì—­ëª…</th>
                            <!-- wd -->
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">STN_ID</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ìœ„ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ê²½ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ì§€ì—­ëª…</th>
                            <!-- ws -->
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">STN_ID</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ìœ„ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ê²½ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ì§€ì—­ëª…</th>
                            <!-- at -->
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">STN_ID</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ìœ„ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ê²½ë„</th>
                            <th style="padding: 6px; border: 1px solid #ddd; font-size: 0.9em;">ì§€ì—­ëª…</th>
                        </tr>
                    </thead>
                    <tbody id="previewTableBody">
                    </tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" onclick="uploadToSupabase()">ğŸ“¤ tide_abs_region í…Œì´ë¸”ì— ì—…ë¡œë“œ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://iwpgvdtfpwazzfeniusk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3cGd2ZHRmcHdhenpmZW5pdXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNzEzOTQsImV4cCI6MjA2NjY0NzM5NH0.d0pjIvnOdPGbc_-cfqRNu9yOIutyO1eex848k1yNZJE';

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        let supabaseClient;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error('Supabase library not loaded');
            }
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        // ë§¤ì¹­ ë°ì´í„° (Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìƒì„±ëœ JSONì„ í•˜ë“œì½”ë”©)
        let STATION_MATCHING_DATA = {};
        let analysisResults = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        async function initializePage() {
            // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜ ê¸°ì¤€ ì¼ì£¼ì¼ ì „ ~ ì˜¤ëŠ˜)
            setDefaultDates();

            // ë§¤ì¹­ ë°ì´í„° ë¡œë“œ
            await loadMatchingData();

            // ì¡°ì„ê´€ì¸¡ì†Œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            populateTideStationSelect();
        }

        function setDefaultDates() {
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);

            // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('startDate').value = formatDate(weekAgo);
            document.getElementById('endDate').value = formatDate(today);
        }

        async function loadMatchingData() {
            // JSON íŒŒì¼ì—ì„œ ë§¤ì¹­ ë°ì´í„° ë¡œë“œ
            try {
                const response = await fetch('station_matching_top5.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch matching data');
                }
                STATION_MATCHING_DATA = await response.json();
                console.log('ë§¤ì¹­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(STATION_MATCHING_DATA).length, 'ê°œ ì¡°ì„ê´€ì¸¡ì†Œ');
            } catch (error) {
                console.error('ë§¤ì¹­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë§¤ì¹­ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. station_matching_top5.json íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function populateTideStationSelect() {
            const select = document.getElementById('tideStationSelect');

            for (const [code, data] of Object.entries(STATION_MATCHING_DATA)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${data.tide_station_name}`;
                select.appendChild(option);
            }

            // ì¡°ì„ê´€ì¸¡ì†Œ ì„ íƒ ì‹œ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ ëª©ë¡ í‘œì‹œ (ë‹¨ì¼ ì„ íƒì¼ ë•Œë§Œ)
            select.addEventListener('change', function() {
                const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);

                // í•œ ê°œë§Œ ì„ íƒë˜ì—ˆê³  "all"ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ í‘œì‹œ
                if (selectedOptions.length === 1 && selectedOptions[0] !== 'all') {
                    showNearestStations(selectedOptions[0]);
                } else {
                    // ì—¬ëŸ¬ ê°œ ì„ íƒë˜ì—ˆê±°ë‚˜ "ì „ì²´" ì„ íƒ ì‹œ ëª©ë¡ ìˆ¨ê¹€
                    document.getElementById('nearestStationsSection').style.display = 'none';
                }
            });
        }

        function showNearestStations(tideStationCode) {
            const section = document.getElementById('nearestStationsSection');
            const listDiv = document.getElementById('nearestStationsList');

            // "ì „ì²´ ì¡°ì„ê´€ì¸¡ì†Œ" ì„ íƒ ì‹œ ì„¹ì…˜ ìˆ¨ê¹€
            if (tideStationCode === 'all') {
                section.style.display = 'none';
                return;
            }

            const stationData = STATION_MATCHING_DATA[tideStationCode];
            if (!stationData) {
                section.style.display = 'none';
                return;
            }

            // ì„¹ì…˜ í‘œì‹œ
            section.style.display = 'block';

            // ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ëª©ë¡ ìƒì„±
            const nearestStations = stationData.nearest_marine_stations || [];

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                    <strong>ì¡°ì„ê´€ì¸¡ì†Œ:</strong> ${stationData.tide_station_name} (${tideStationCode})<br>
                    <strong>ìœ„ì¹˜:</strong> ìœ„ë„ ${stationData.tide_station_lat}, ê²½ë„ ${stationData.tide_station_lon}<br>
                    <strong>í•´ì—­:</strong> ${stationData.marine_reg_name}
                </div>
                <table style="width: 100%; border-collapse: collapse; background: white;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">ìˆœìœ„</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">ê´€ì¸¡ì†Œ ID</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">ê´€ì¸¡ì†Œëª… / ìœ„ì¹˜</th>
                            <th style="padding: 10px; border: 1px solid #ddd; text-align: right;">ê±°ë¦¬</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">ì œê³µ í•„ë“œ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            nearestStations.forEach((station, index) => {
                const fieldLabels = {
                    'wt': 'ìˆ˜ì˜¨',
                    'swh': 'íŒŒê³ ',
                    'wd': 'í’í–¥',
                    'ws': 'í’ì†',
                    'at': 'ê¸°ì˜¨'
                };
                const providesText = station.provides.map(f => fieldLabels[f] || f).join(', ');

                html += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${index + 1}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${station.station_id}</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <strong>${station.name}</strong><br>
                            <span style="font-size: 0.85em; color: #666;">ìœ„ë„: ${station.lat}, ê²½ë„: ${station.lon}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">
                            ${station.distance_km} km
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">${providesText}</span>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            listDiv.innerHTML = html;
        }

        // ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
        function showNearestStationsPopup() {
            const select = document.getElementById('tideStationSelect');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);

            if (selectedOptions.length === 0) {
                alert('ì¡°ì„ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì²˜ë¦¬í•  ì¡°ì„ê´€ì¸¡ì†Œ ëª©ë¡
            let stationsToShow = [];
            if (selectedOptions.includes('all')) {
                stationsToShow = Object.keys(STATION_MATCHING_DATA);
            } else {
                stationsToShow = selectedOptions;
            }

            let contentHtml = '';

            // ê° ì¡°ì„ê´€ì¸¡ì†Œë³„ë¡œ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ ëª©ë¡ ìƒì„±
            for (const stationCode of stationsToShow) {
                const stationData = STATION_MATCHING_DATA[stationCode];
                if (!stationData) continue;

                const nearestStations = stationData.nearest_marine_stations || [];

                contentHtml += `
                    <div style="margin-bottom: 40px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; page-break-inside: avoid;">
                        <div style="padding: 15px; background: #f8f9fa; border-bottom: 2px solid #667eea;">
                            <h3 style="margin: 0 0 10px 0; color: #333;">
                                ${stationCode} - ${stationData.tide_station_name}
                            </h3>
                            <div style="font-size: 0.9em; color: #666;">
                                <strong>ìœ„ì¹˜:</strong> ìœ„ë„ ${stationData.tide_station_lat}, ê²½ë„ ${stationData.tide_station_lon} |
                                <strong>í•´ì—­:</strong> ${stationData.marine_reg_name}
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #e9ecef;">
                                    <tr>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: center; width: 60px;">ìˆœìœ„</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; width: 100px;">ê´€ì¸¡ì†Œ ID</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">ê´€ì¸¡ì†Œëª… / ìœ„ì¹˜</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; text-align: right; width: 100px;">ê±°ë¦¬</th>
                                        <th style="padding: 10px; border: 1px solid #ddd; width: 150px;">ì œê³µ í•„ë“œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                nearestStations.forEach((station, index) => {
                    const fieldLabels = {
                        'wt': 'ìˆ˜ì˜¨',
                        'swh': 'íŒŒê³ ',
                        'wd': 'í’í–¥',
                        'ws': 'í’ì†',
                        'at': 'ê¸°ì˜¨'
                    };
                    const providesText = station.provides.map(f => fieldLabels[f] || f).join(', ');

                    contentHtml += `
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${index + 1}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">${station.station_id}</td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <strong>${station.name}</strong><br>
                                <span style="font-size: 0.85em; color: #666;">ìœ„ë„: ${station.lat}, ê²½ë„: ${station.lon}</span>
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">
                                ${station.distance_km} km
                            </td>
                            <td style="padding: 10px; border: 1px solid #ddd;">
                                <span style="background: #e3f2fd; padding: 3px 8px; border-radius: 3px; font-size: 0.9em;">${providesText}</span>
                            </td>
                        </tr>
                    `;
                });

                contentHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            if (contentHtml === '') {
                contentHtml = '<p style="text-align: center; padding: 40px; color: #666;">ì„ íƒëœ ì¡°ì„ê´€ì¸¡ì†Œì˜ ë§¤ì¹­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                contentHtml = `<div style="margin-bottom: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #667eea; border-radius: 4px;">
                    <strong>ì´ ${stationsToShow.length}ê°œ ì¡°ì„ê´€ì¸¡ì†Œ</strong>ì˜ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ ëª©ë¡ì…ë‹ˆë‹¤.
                </div>` + contentHtml;
            }

            // ìƒˆ ì°½ì— í‘œì‹œí•  ì™„ì „í•œ HTML ë¬¸ì„œ ìƒì„±
            const newWindowHtml = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ ëª©ë¡ (ê±°ë¦¬ìˆœ ìƒìœ„ 5ê°œ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 0.95em;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .print-button:hover {
            background: #218838;
        }
        @media print {
            body {
                background: white;
                padding: 0;
            }
            .print-button {
                display: none;
            }
            .header {
                background: #667eea;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„</button>

    <div class="header">
        <h1>ğŸ“ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œ ëª©ë¡</h1>
        <p>ì¡°ì„ê´€ì¸¡ì†Œë³„ ê±°ë¦¬ìˆœ ìƒìœ„ 5ê°œ í•´ì–‘ê´€ì¸¡ì†Œ ì •ë³´</p>
    </div>

    <div class="container">
        ${contentHtml}
    </div>

    <div class="footer">
        <p>ìƒì„±ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}</p>
        <p>ì¡°ì„-í•´ì–‘ ê´€ì¸¡ì†Œ ë§¤ì¹­ ì‹œìŠ¤í…œ | Marine Station Matcher</p>
    </div>
</body>
</html>
            `;

            // ìƒˆ ì°½ ì—´ê¸°
            const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');

            if (newWindow) {
                newWindow.document.write(newWindowHtml);
                newWindow.document.close();
                newWindow.focus();
            } else {
                alert('íŒì—… ì°¨ë‹¨ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. íŒì—… í—ˆìš© í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        async function analyzeAndMatch() {
            const select = document.getElementById('tideStationSelect');
            const selectedOptions = Array.from(select.selectedOptions).map(opt => opt.value);
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (selectedOptions.length === 0) {
                alert('ì¡°ì„ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';

            try {
                // ì²˜ë¦¬í•  ì¡°ì„ê´€ì¸¡ì†Œ ëª©ë¡
                let stationsToProcess = [];

                if (selectedOptions.includes('all')) {
                    // "ì „ì²´ ì¡°ì„ê´€ì¸¡ì†Œ"ê°€ ì„ íƒëœ ê²½ìš°
                    stationsToProcess = Object.keys(STATION_MATCHING_DATA);
                } else {
                    // ì„ íƒëœ ì¡°ì„ê´€ì¸¡ì†Œë“¤
                    stationsToProcess = selectedOptions;
                }

                analysisResults = {};

                for (const stationCode of stationsToProcess) {
                    const matchingData = STATION_MATCHING_DATA[stationCode];

                    // abs_fetch_logì—ì„œ ë°ì´í„° ë¶„ì„
                    const analysis = await analyzeAbsFetchLog(
                        matchingData.nearest_marine_stations,
                        startDate,
                        endDate
                    );

                    analysisResults[stationCode] = {
                        ...matchingData,
                        fieldRecommendations: analysis
                    };
                }

                // ê²°ê³¼ í‘œì‹œ
                displayResults();

            } catch (error) {
                console.error('ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function analyzeAbsFetchLog(marineStations, startDate, endDate) {
            const fields = ['wt', 'swh', 'wd', 'ws', 'at'];
            const fieldNames = {
                wt: 'ìˆ˜ì˜¨ (Water Temperature)',
                swh: 'íŒŒê³  (Significant Wave Height)',
                wd: 'í’í–¥ (Wind Direction)',
                ws: 'í’ì† (Wind Speed)',
                at: 'ê¸°ì˜¨ (Air Temperature)'
            };

            const recommendations = {};

            for (const field of fields) {
                // í•´ë‹¹ í•„ë“œë¥¼ ì œê³µí•˜ëŠ” ê´€ì¸¡ì†Œë§Œ í•„í„°
                const candidateStations = marineStations.filter(station =>
                    station.provides.includes(field)
                );

                const stationStats = [];

                // ê° ê´€ì¸¡ì†Œë³„ë¡œ abs_fetch_log ë°ì´í„° ë¶„ì„
                for (const station of candidateStations) {
                    const stats = await getStationStats(station.station_id, field, startDate, endDate);
                    stationStats.push({
                        ...station,
                        stats: stats
                    });
                }

                // ìœ íš¨ ë°ì´í„°ê°€ 0ê±´ì¸ ê´€ì¸¡ì†Œ ì œì™¸ (í•„ìˆ˜ ì¡°ê±´)
                // ì˜ˆ: ì¸ì²œ(ì†¡ë„) 3km ìœ íš¨ 0ê±´ ì œì™¸, ì•ˆì‚° 12km ìœ íš¨ 1ê±´ ì„ íƒ
                const validStations = stationStats.filter(station =>
                    station.stats.valid_records > 0
                );

                // ê±°ë¦¬ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ (1ìˆœìœ„)
                // ê°€ì¥ ê°€ê¹Œìš´ ê´€ì¸¡ì†Œ ì¤‘ì—ì„œ í•´ë‹¹ í•„ë“œë¥¼ ì œê³µí•˜ëŠ” ê³³ ì„ íƒ
                // 1. ê±°ë¦¬ (distance_km) - ê°€ê¹Œìš´ ìˆœ
                // 2. ìœ íš¨ ë°ì´í„° ë¹„ìœ¨ (valid_ratio) - ê±°ë¦¬ê°€ ê°™ì„ ë•Œ
                // 3. í‰ê·  ìˆ˜ì§‘ ê°„ê²© (avg_interval) - ê±°ë¦¬ì™€ ë¹„ìœ¨ì´ ê°™ì„ ë•Œ
                validStations.sort((a, b) => {
                    if (a.distance_km !== b.distance_km) {
                        return a.distance_km - b.distance_km;
                    }
                    if (b.stats.valid_ratio !== a.stats.valid_ratio) {
                        return b.stats.valid_ratio - a.stats.valid_ratio;
                    }
                    return a.stats.avg_interval - b.stats.avg_interval;
                });

                // ìƒìœ„ 2ê°œ ì¶”ì²œ
                recommendations[field] = {
                    field_name: fieldNames[field],
                    candidates: validStations.slice(0, 2)
                };
            }

            return recommendations;
        }

        async function getStationStats(stationId, field, startDate, endDate) {
            try {
                // observation_time_kst í˜•ì‹: YYYYMMDDHHMM
                const startDateStr = startDate.replace(/-/g, '') + '0000';
                const endDateStr = endDate.replace(/-/g, '') + '2359';

                // í•„ë“œëª… ë§¤í•‘ (ë‚´ë¶€ í‚¤ â†’ marine_observations ì»¬ëŸ¼ëª…)
                const fieldMapping = {
                    'wt': 'water_temperature',
                    'swh': 'significant_wave_height',
                    'wd': 'wind_direction',
                    'ws': 'wind_speed',
                    'at': 'air_temperature'
                };

                const dbFieldName = fieldMapping[field];
                if (!dbFieldName) {
                    throw new Error(`Unknown field: ${field}`);
                }

                // Paginationìœ¼ë¡œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (1000ê°œ ì œí•œ íšŒí”¼)
                let allData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('marine_observations')
                        .select('observation_time_kst, ' + dbFieldName)
                        .eq('station_id', stationId)
                        .gte('observation_time_kst', startDateStr)
                        .lte('observation_time_kst', endDateStr)
                        .order('observation_time_kst', { ascending: true })
                        .range(from, from + batchSize - 1);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                    }

                    if (!data || data.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                }

                const data = allData;

                if (!data || data.length === 0) {
                    return {
                        total_records: 0,
                        valid_records: 0,
                        valid_ratio: 0,
                        avg_interval: null,
                        data_quality: 'ë°ì´í„° ì—†ìŒ'
                    };
                }

                // ìœ íš¨í•œ ë°ì´í„° ê°œìˆ˜ (nullì´ ì•„ë‹Œ ê°’)
                const validRecords = data.filter(row => row[dbFieldName] !== null && row[dbFieldName] !== '').length;
                const validRatio = (validRecords / data.length * 100).toFixed(1);

                // í‰ê·  ìˆ˜ì§‘ ê°„ê²© ê³„ì‚° (ë¶„ ë‹¨ìœ„)
                let avgInterval = null;
                if (data.length > 1) {
                    const intervals = [];
                    for (let i = 1; i < data.length; i++) {
                        const prevTime = parseObservationTime(data[i-1].observation_time_kst);
                        const currTime = parseObservationTime(data[i].observation_time_kst);
                        const diff = (currTime - prevTime) / (1000 * 60); // ë¶„ ë‹¨ìœ„
                        intervals.push(diff);
                    }
                    avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
                }

                // ë°ì´í„° í’ˆì§ˆ í‰ê°€
                let dataQuality = 'ìš°ìˆ˜';
                if (validRatio < 50) dataQuality = 'ë¶ˆëŸ‰';
                else if (validRatio < 80) dataQuality = 'ë³´í†µ';

                return {
                    total_records: data.length,
                    valid_records: validRecords,
                    valid_ratio: parseFloat(validRatio),
                    avg_interval: avgInterval,
                    data_quality: dataQuality
                };

            } catch (error) {
                console.error(`ê´€ì¸¡ì†Œ ${stationId} í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                return {
                    total_records: 0,
                    valid_records: 0,
                    valid_ratio: 0,
                    avg_interval: null,
                    data_quality: 'ì¡°íšŒ ì‹¤íŒ¨'
                };
            }
        }

        function parseObservationTime(timeStr) {
            // YYYYMMDDHHMM -> Date ê°ì²´
            const year = parseInt(timeStr.substring(0, 4));
            const month = parseInt(timeStr.substring(4, 6)) - 1;
            const day = parseInt(timeStr.substring(6, 8));
            const hour = parseInt(timeStr.substring(8, 10));
            const minute = parseInt(timeStr.substring(10, 12));
            return new Date(year, month, day, hour, minute);
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            container.style.display = 'block';

            for (const [stationCode, data] of Object.entries(analysisResults)) {
                const card = createStationCard(stationCode, data);
                container.appendChild(card);

                // ì²« ë²ˆì§¸ í›„ë³´ë¥¼ ìë™ ì„ íƒ
                autoSelectFirstCandidates(stationCode, data);
            }

            // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
            document.getElementById('previewSection').style.display = 'block';
            updatePreviewTable();
        }

        function autoSelectFirstCandidates(stationCode, data) {
            // ê° í•„ë“œë³„ë¡œ ì²« ë²ˆì§¸ í›„ë³´ë¥¼ ìë™ ì„ íƒ
            for (const [fieldKey, fieldData] of Object.entries(data.fieldRecommendations)) {
                if (fieldData.candidates && fieldData.candidates.length > 0) {
                    const firstCandidate = fieldData.candidates[0];
                    const recId = `rec-${stationCode}-${fieldKey}-0`;

                    // ì„ íƒ ìƒíƒœ ì„¤ì •
                    if (!selectedMappings[stationCode]) {
                        selectedMappings[stationCode] = {};
                    }
                    selectedMappings[stationCode][fieldKey] = firstCandidate.station_id;

                    // UI ì—…ë°ì´íŠ¸ëŠ” ë‚˜ì¤‘ì— DOMì´ ë Œë”ë§ëœ í›„ ì‹¤í–‰
                    setTimeout(() => {
                        const recCard = document.getElementById(recId);
                        if (recCard) {
                            recCard.classList.add('selected');
                            const btn = recCard.querySelector('.select-btn');
                            if (btn) {
                                btn.textContent = 'ì„ íƒë¨';
                                btn.classList.add('selected');
                            }
                        }
                    }, 100);
                }
            }
        }

        function createStationCard(stationCode, data) {
            const card = document.createElement('div');
            card.className = 'station-card';
            card.id = `station-${stationCode}`;

            let html = `
                <div class="station-header">
                    <div>
                        <div class="station-title">${stationCode} - ${data.tide_station_name}</div>
                        <div class="station-info">
                            ìœ„ì¹˜: ${data.tide_station_lat.toFixed(4)}, ${data.tide_station_lon.toFixed(4)} |
                            í•´ì—­: ${data.marine_reg_name}
                        </div>
                    </div>
                </div>
            `;

            // ê° í•„ë“œë³„ ì¶”ì²œ
            for (const [fieldKey, fieldData] of Object.entries(data.fieldRecommendations)) {
                html += `
                    <div class="field-section">
                        <div class="field-title">ğŸ“Š ${fieldData.field_name}</div>
                `;

                fieldData.candidates.forEach((candidate, index) => {
                    const recId = `rec-${stationCode}-${fieldKey}-${index}`;
                    const stats = candidate.stats;

                    html += `
                        <div class="recommendation-card" id="${recId}">
                            <div class="rec-header">
                                <div>
                                    <span class="rec-name">${candidate.name} (${candidate.station_id})</span>
                                    <span style="color: #666; font-size: 14px; margin-left: 10px;">
                                        ${candidate.distance_km}km
                                    </span>
                                </div>
                                <button class="select-btn" onclick="selectRecommendation('${stationCode}', '${fieldKey}', ${index}, '${recId}')">
                                    ì„ íƒ
                                </button>
                            </div>
                            <div class="rec-stats">
                                <div class="stat-item">
                                    <div class="stat-label">ì „ì²´ ë ˆì½”ë“œ</div>
                                    <div class="stat-value">${stats.total_records}ê±´</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ìœ íš¨ ë°ì´í„°</div>
                                    <div class="stat-value">${stats.valid_records}ê±´ (${stats.valid_ratio}%)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">í‰ê·  ìˆ˜ì§‘ ì£¼ê¸°</div>
                                    <div class="stat-value">${stats.avg_interval ? stats.avg_interval + 'ë¶„' : 'N/A'}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ë°ì´í„° í’ˆì§ˆ</div>
                                    <div class="stat-value">${stats.data_quality}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            card.innerHTML = html;
            return card;
        }

        // ì„ íƒëœ ë§¤ì¹­ ì •ë³´ ì €ì¥
        const selectedMappings = {};

        function selectRecommendation(stationCode, fieldKey, candidateIndex, recId) {
            // í•´ë‹¹ í•„ë“œì˜ ë‹¤ë¥¸ ì„ íƒ í•´ì œ
            const fieldSection = document.getElementById(recId).closest('.field-section');
            fieldSection.querySelectorAll('.recommendation-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.select-btn').textContent = 'ì„ íƒ';
                card.querySelector('.select-btn').classList.remove('selected');
            });

            // í˜„ì¬ ì„ íƒ í™œì„±í™”
            const recCard = document.getElementById(recId);
            recCard.classList.add('selected');
            const btn = recCard.querySelector('.select-btn');
            btn.textContent = 'ì„ íƒë¨';
            btn.classList.add('selected');

            // ì„ íƒ ì •ë³´ ì €ì¥
            if (!selectedMappings[stationCode]) {
                selectedMappings[stationCode] = {};
            }

            const candidate = analysisResults[stationCode].fieldRecommendations[fieldKey].candidates[candidateIndex];
            selectedMappings[stationCode][fieldKey] = candidate.station_id;

            updatePreviewTable();
        }

        function updateUploadSummary() {
            const totalStations = Object.keys(analysisResults).length;
            const mappedStations = Object.keys(selectedMappings).length;

            const summary = document.getElementById('uploadSummary');
            summary.innerHTML = `
                <strong>ë§¤ì¹­ í˜„í™©:</strong> ${mappedStations} / ${totalStations} ê°œ ì¡°ì„ê´€ì¸¡ì†Œ<br>
                <small>ê° ì¡°ì„ê´€ì¸¡ì†Œë§ˆë‹¤ 5ê°œ í•„ë“œ(wt, swh, wd, ws, at)ì˜ í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</small>
            `;
        }

        // ëª¨ë“  í•´ì–‘ê´€ì¸¡ì†Œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function findMarineStationById(stationId) {
            if (!stationId) return null;

            // analysisResultsì—ì„œ ëª¨ë“  í•„ë“œì˜ í›„ë³´ ê´€ì¸¡ì†Œ ê²€ìƒ‰
            for (const stationCode in analysisResults) {
                const data = analysisResults[stationCode];
                const fields = ['wt', 'swh', 'wd', 'ws', 'at'];

                for (const field of fields) {
                    const candidates = data.fieldRecommendations[field]?.candidates || [];
                    const found = candidates.find(c => c.station_id === stationId);
                    if (found) {
                        return {
                            station_id: found.station_id,
                            lat: found.lat,
                            lon: found.lon,
                            name: found.name
                        };
                    }
                }
            }

            // station_matching_top5.jsonì—ì„œë„ ê²€ìƒ‰
            for (const tideCode in STATION_MATCHING_DATA) {
                const tideData = STATION_MATCHING_DATA[tideCode];
                const found = tideData.nearest_marine_stations?.find(s => s.station_id === stationId);
                if (found) {
                    return {
                        station_id: found.station_id,
                        lat: found.lat,
                        lon: found.lon,
                        name: found.name
                    };
                }
            }

            return null;
        }

        // STN_ID ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ì •ë³´ ì±„ìš°ê¸°
        function autoFillMarineStationInfo(idCell) {
            const stationId = idCell.textContent.trim();
            if (!stationId) return;

            const field = idCell.getAttribute('data-field');
            const row = idCell.parentElement;

            // í•´ë‹¹ ê´€ì¸¡ì†Œ ì •ë³´ ì°¾ê¸°
            const stationInfo = findMarineStationById(stationId);

            if (stationInfo) {
                // ê°™ì€ fieldì˜ lat, lon, name ì…€ ì°¾ì•„ì„œ ìë™ ì…ë ¥
                const cells = row.querySelectorAll(`td[data-field="${field}"]`);

                for (const cell of cells) {
                    const column = cell.getAttribute('data-column');

                    if (column === 'lat') {
                        cell.textContent = stationInfo.lat;
                        cell.style.background = 'white';
                    } else if (column === 'lon') {
                        cell.textContent = stationInfo.lon;
                        cell.style.background = 'white';
                    } else if (column === 'name') {
                        cell.textContent = stationInfo.name;
                        cell.style.background = 'white';
                    }
                }

                // ID ì…€ ë°°ê²½ë„ í°ìƒ‰ìœ¼ë¡œ ë³€ê²½
                idCell.style.background = 'white';

                console.log(`âœ“ ê´€ì¸¡ì†Œ ${stationId} ì •ë³´ ìë™ ì…ë ¥ ì™„ë£Œ:`, stationInfo);
            } else {
                console.warn(`âš ï¸ ê´€ì¸¡ì†Œ ${stationId} ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
        }

        function updatePreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            const summary = document.getElementById('previewSummary');
            const totalStations = Object.keys(analysisResults).length;
            const mappedStations = Object.keys(selectedMappings).length;

            summary.innerHTML = `
                <strong>ë§¤ì¹­ í˜„í™©:</strong> ${mappedStations} / ${totalStations} ê°œ ì¡°ì„ê´€ì¸¡ì†Œ<br>
                <small>ğŸ’¡ STN_IDë¥¼ ì…ë ¥í•˜ë©´ ë‚˜ë¨¸ì§€ ì •ë³´ê°€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ê°’ì„ ìˆ˜ì •í•œ í›„ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ Supabaseì— ì—…ë¡œë“œí•˜ì„¸ìš”.</small>
            `;

            // ì •ë ¬ëœ ì¡°ì„ê´€ì¸¡ì†Œ ëª©ë¡ ìƒì„±
            const sortedStations = Object.keys(analysisResults).sort();

            for (const stationCode of sortedStations) {
                const data = analysisResults[stationCode];
                const mappings = selectedMappings[stationCode] || {};

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.setAttribute('data-station-code', stationCode);

                // ì¡°ì„ê´€ì¸¡ì†Œ ì½”ë“œ (í¸ì§‘ ë¶ˆê°€)
                const codeCell = document.createElement('td');
                codeCell.style.padding = '8px';
                codeCell.style.border = '1px solid #ddd';
                codeCell.style.background = '#f5f5f5';
                codeCell.textContent = stationCode;
                row.appendChild(codeCell);

                // ì¡°ì„ê´€ì¸¡ì†Œëª… (í¸ì§‘ ë¶ˆê°€)
                const nameCell = document.createElement('td');
                nameCell.style.padding = '8px';
                nameCell.style.border = '1px solid #ddd';
                nameCell.style.background = '#f5f5f5';
                nameCell.textContent = data.tide_station_name;
                row.appendChild(nameCell);

                // ê° í•„ë“œë³„ 4ê°œ ì»¬ëŸ¼ (STN_ID, ìœ„ë„, ê²½ë„, ì§€ì—­ëª…)
                const fields = ['wt', 'swh', 'wd', 'ws', 'at'];
                for (const field of fields) {
                    let stationId = '';
                    let lat = '';
                    let lon = '';
                    let name = '';

                    if (mappings[field]) {
                        // ì„ íƒëœ ê´€ì¸¡ì†Œ ì •ë³´ ì°¾ê¸°
                        const candidates = data.fieldRecommendations[field]?.candidates || [];
                        const selected = candidates.find(c => c.station_id === mappings[field]);

                        if (selected) {
                            stationId = selected.station_id;
                            lat = selected.lat;
                            lon = selected.lon;
                            name = selected.name;
                        } else {
                            stationId = mappings[field];
                        }
                    }

                    // STN_ID ì…€ (í¸ì§‘ ê°€ëŠ¥)
                    const idCell = document.createElement('td');
                    idCell.style.padding = '8px';
                    idCell.style.border = '1px solid #ddd';
                    idCell.style.minWidth = '80px';
                    idCell.contentEditable = 'true';
                    idCell.textContent = stationId;
                    idCell.setAttribute('data-field', field);
                    idCell.setAttribute('data-column', 'id');
                    idCell.style.cursor = 'text';
                    idCell.style.background = stationId ? 'white' : '#fff9c4';

                    // STN_ID ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ë‚˜ë¨¸ì§€ ì •ë³´ ì±„ìš°ê¸°
                    idCell.addEventListener('blur', function() {
                        autoFillMarineStationInfo(this);
                    });

                    // Enter í‚¤ë¡œë„ ë™ì‘í•˜ë„ë¡
                    idCell.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    });

                    row.appendChild(idCell);

                    // ìœ„ë„ ì…€ (í¸ì§‘ ê°€ëŠ¥)
                    const latCell = document.createElement('td');
                    latCell.style.padding = '8px';
                    latCell.style.border = '1px solid #ddd';
                    latCell.style.minWidth = '80px';
                    latCell.contentEditable = 'true';
                    latCell.textContent = lat;
                    latCell.setAttribute('data-field', field);
                    latCell.setAttribute('data-column', 'lat');
                    latCell.style.cursor = 'text';
                    latCell.style.background = lat ? 'white' : '#fff9c4';
                    row.appendChild(latCell);

                    // ê²½ë„ ì…€ (í¸ì§‘ ê°€ëŠ¥)
                    const lonCell = document.createElement('td');
                    lonCell.style.padding = '8px';
                    lonCell.style.border = '1px solid #ddd';
                    lonCell.style.minWidth = '80px';
                    lonCell.contentEditable = 'true';
                    lonCell.textContent = lon;
                    lonCell.setAttribute('data-field', field);
                    lonCell.setAttribute('data-column', 'lon');
                    lonCell.style.cursor = 'text';
                    lonCell.style.background = lon ? 'white' : '#fff9c4';
                    row.appendChild(lonCell);

                    // ì§€ì—­ëª… ì…€ (í¸ì§‘ ê°€ëŠ¥)
                    const nameEditCell = document.createElement('td');
                    nameEditCell.style.padding = '8px';
                    nameEditCell.style.border = '1px solid #ddd';
                    nameEditCell.style.minWidth = '100px';
                    nameEditCell.contentEditable = 'true';
                    nameEditCell.textContent = name;
                    nameEditCell.setAttribute('data-field', field);
                    nameEditCell.setAttribute('data-column', 'name');
                    nameEditCell.style.cursor = 'text';
                    nameEditCell.style.background = name ? 'white' : '#fff9c4';
                    row.appendChild(nameEditCell);
                }

                tbody.appendChild(row);
            }

            // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
            document.getElementById('previewSection').style.display = 'block';
        }

        function downloadExcel() {
            const tbody = document.getElementById('previewTableBody');
            const rows = tbody.querySelectorAll('tr');

            if (rows.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§¤ì¹­ ì‹¤í–‰ì„ í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì—‘ì…€ ë°ì´í„° ìƒì„±
            const excelData = [];

            // í—¤ë”
            excelData.push([
                'Code', 'Name',
                'wt_STN_ID', 'wt_ìœ„ë„(LAT)', 'wt_ê²½ë„(LON)', 'wt_ì§€ì—­ëª…(í•œê¸€)',
                'swh_STN_ID', 'swh_ìœ„ë„(LAT)', 'swh_ê²½ë„(LON)', 'swh_ì§€ì—­ëª…(í•œê¸€)',
                'wd_STN_ID', 'wd_ìœ„ë„(LAT)', 'wd_ê²½ë„(LON)', 'wd_ì§€ì—­ëª…(í•œê¸€)',
                'ws_STN_ID', 'ws_ìœ„ë„(LAT)', 'ws_ê²½ë„(LON)', 'ws_ì§€ì—­ëª…(í•œê¸€)',
                'at_STN_ID', 'at_ìœ„ë„(LAT)', 'at_ê²½ë„(LON)', 'at_ì§€ì—­ëª…(í•œê¸€)'
            ]);

            // ë°ì´í„° í–‰ - í…Œì´ë¸”ì—ì„œ ì§ì ‘ ì½ê¸° (ìˆ˜ì •ëœ ê°’ í¬í•¨)
            for (const row of rows) {
                const cells = row.querySelectorAll('td');
                const rowData = [];

                // ëª¨ë“  ì…€ ê°’ ì½ê¸° (í¸ì§‘ ë¶ˆê°€ëŠ¥í•œ ì…€ + í¸ì§‘ ê°€ëŠ¥í•œ ì…€)
                for (const cell of cells) {
                    rowData.push(cell.textContent.trim());
                }

                excelData.push(rowData);
            }

            // SheetJSë¡œ ì—‘ì…€ íŒŒì¼ ìƒì„±
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì • (22ê°œ ì»¬ëŸ¼)
            ws['!cols'] = [
                { wch: 12 }, // Code
                { wch: 15 }, // Name
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, // wt
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, // swh
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, // wd
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }, // ws
                { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 15 }  // at
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'tide_abs_region');

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const today = new Date().toISOString().split('T')[0];
            const filename = `tide_abs_region_${today}.xlsx`;
            XLSX.writeFile(wb, filename);

            console.log('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
        }

        async function uploadToSupabase() {
            const tbody = document.getElementById('previewTableBody');
            const rows = tbody.querySelectorAll('tr');

            if (rows.length === 0) {
                alert('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë§¤ì¹­ ì‹¤í–‰ì„ í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`${rows.length}ê°œ ì¡°ì„ê´€ì¸¡ì†Œì˜ ë§¤ì¹­ ì •ë³´ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í…Œì´ë¸”ì—ì„œ ìˆ˜ì •í•œ ê°’ì´ ê·¸ëŒ€ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const updates = [];
                const fields = ['wt', 'swh', 'wd', 'ws', 'at'];

                // ê° í–‰ì„ ìˆœíšŒí•˜ë©´ì„œ ë°ì´í„° ì½ê¸°
                for (const row of rows) {
                    const stationCode = row.getAttribute('data-station-code');
                    if (!stationCode) continue;

                    const updateData = {};

                    // ê° í•„ë“œë³„ë¡œ 4ê°œ ì»¬ëŸ¼(id, lat, lon, name) ì½ê¸°
                    const cells = row.querySelectorAll('td[contenteditable="true"]');

                    for (const cell of cells) {
                        const field = cell.getAttribute('data-field');
                        const column = cell.getAttribute('data-column');
                        const value = cell.textContent.trim();

                        if (!field || !column) continue;

                        // ì»¬ëŸ¼ëª… ë§¤í•‘
                        const columnMapping = {
                            'id': `${field}_STN_ID`,
                            'lat': `${field}_ìœ„ë„(LAT)`,
                            'lon': `${field}_ê²½ë„(LON)`,
                            'name': `${field}_ì§€ì—­ëª…(í•œê¸€)`
                        };

                        const dbColumn = columnMapping[column];
                        if (dbColumn) {
                            // ë¹ˆ ê°’ì€ nullë¡œ ì²˜ë¦¬
                            if (value === '') {
                                updateData[dbColumn] = null;
                            } else {
                                // ìœ„ë„/ê²½ë„ëŠ” ìˆ«ìë¡œ ë³€í™˜
                                if (column === 'lat' || column === 'lon') {
                                    const numValue = parseFloat(value);
                                    updateData[dbColumn] = isNaN(numValue) ? null : numValue;
                                } else {
                                    updateData[dbColumn] = value;
                                }
                            }
                        }
                    }

                    console.log(`Updating ${stationCode}:`, updateData);

                    const { error } = await supabaseClient
                        .from('tide_abs_region')
                        .update(updateData)
                        .eq('Code', stationCode);

                    if (error) {
                        console.error(`Failed to update ${stationCode}:`, error);
                        throw error;
                    }

                    updates.push(stationCode);
                }

                alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n${updates.length}ê°œ ì¡°ì„ê´€ì¸¡ì†Œì˜ í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì—…ë°ì´íŠ¸ëœ ì»¬ëŸ¼:\n- ê° í•„ë“œë³„ STN_ID\n- ìœ„ë„(LAT)\n- ê²½ë„(LON)\n- ì§€ì—­ëª…(í•œê¸€)`);

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
