<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡°ì„ê´€ì¸¡ì†Œ - í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ê´€ë¦¬</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 20px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        select, input[type="date"] {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-container {
            display: none;
        }

        .station-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .station-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .station-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .station-info {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .field-section {
            margin-bottom: 20px;
        }

        .field-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .recommendation-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
        }

        .recommendation-card.selected {
            background: #e8f4ff;
            border-left-color: #11998e;
        }

        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rec-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .rec-badge {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .rec-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }

        .stat-label {
            color: #888;
            font-size: 11px;
            margin-bottom: 3px;
        }

        .stat-value {
            color: #333;
            font-weight: 600;
        }

        .select-btn {
            padding: 6px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .select-btn:hover {
            background: #5568d3;
        }

        .select-btn.selected {
            background: #11998e;
        }

        .upload-section {
            background: white;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        #previewTable {
            font-size: 13px;
        }

        #previewTable th {
            position: sticky;
            top: 0;
            background: #667eea;
            color: white;
            z-index: 10;
        }

        #previewTable tr:hover {
            background: #f8f9fa;
        }

        .summary {
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e8f4ff;
            color: #0066cc;
            border-left: 4px solid #0066cc;
        }

        .alert-success {
            background: #e8f8f5;
            color: #00a67d;
            border-left: 4px solid #00a67d;
        }

        .alert-error {
            background: #ffe8e8;
            color: #cc0000;
            border-left: 4px solid #cc0000;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
            transition: gap 0.2s;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
        }

        .back-button:hover {
            gap: 12px;
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <a href="/" class="back-button">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
    <div class="container">
        <h1>ğŸŒŠ ì¡°ì„ê´€ì¸¡ì†Œ - í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ê´€ë¦¬</h1>
        <p class="subtitle">marine_observations ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ì‹¤ì œ ìœ íš¨í•œ í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ë§¤ì¹­í•©ë‹ˆë‹¤</p>

        <div class="control-panel">
            <div class="form-row">
                <div class="form-group">
                    <label for="tideStationSelect">ì¡°ì„ê´€ì¸¡ì†Œ ì„ íƒ</label>
                    <select id="tideStationSelect">
                        <option value="all">ì „ì²´ ì¡°ì„ê´€ì¸¡ì†Œ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" value="2026-01-10">
                </div>
                <div class="form-group">
                    <label for="endDate">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" value="2026-01-17">
                </div>
            </div>
            <button class="btn btn-primary" onclick="analyzeAndMatch()">ë§¤ì¹­ ì‹¤í–‰</button>
        </div>

        <div id="loadingSpinner">
            <div class="spinner"></div>
            <p>marine_observations ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        </div>

        <div id="resultsContainer" class="results-container"></div>

        <div id="previewSection" class="upload-section" style="display: none;">
            <h3>ğŸ“‹ ë§¤ì¹­ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="previewSummary" class="summary"></div>
            <div style="overflow-x: auto; margin: 20px 0;">
                <table id="previewTable" style="width: 100%; border-collapse: collapse; background: white;">
                    <thead style="background: #667eea; color: white;">
                        <tr>
                            <th style="padding: 12px; border: 1px solid #ddd;">ì¡°ì„ê´€ì¸¡ì†Œ ì½”ë“œ</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">ì¡°ì„ê´€ì¸¡ì†Œëª…</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">ìˆ˜ì˜¨(wt)</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">íŒŒê³ (swh)</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">í’í–¥(wd)</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">í’ì†(ws)</th>
                            <th style="padding: 12px; border: 1px solid #ddd;">ê¸°ì˜¨(at)</th>
                        </tr>
                    </thead>
                    <tbody id="previewTableBody">
                    </tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-success" onclick="uploadToSupabase()">ğŸ“¤ tide_abs_region í…Œì´ë¸”ì— ì—…ë¡œë“œ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://iwpgvdtfpwazzfeniusk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3cGd2ZHRmcHdhenpmZW5pdXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNzEzOTQsImV4cCI6MjA2NjY0NzM5NH0.d0pjIvnOdPGbc_-cfqRNu9yOIutyO1eex848k1yNZJE';

        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        let supabaseClient;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.error('Supabase library not loaded');
            }
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        // ë§¤ì¹­ ë°ì´í„° (Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ìƒì„±ëœ JSONì„ í•˜ë“œì½”ë”©)
        let STATION_MATCHING_DATA = {};
        let analysisResults = {};

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        async function initializePage() {
            // ë§¤ì¹­ ë°ì´í„° ë¡œë“œ
            await loadMatchingData();

            // ì¡°ì„ê´€ì¸¡ì†Œ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
            populateTideStationSelect();
        }

        async function loadMatchingData() {
            // JSON íŒŒì¼ì—ì„œ ë§¤ì¹­ ë°ì´í„° ë¡œë“œ
            try {
                const response = await fetch('station_matching_top10.json');
                if (!response.ok) {
                    throw new Error('Failed to fetch matching data');
                }
                STATION_MATCHING_DATA = await response.json();
                console.log('ë§¤ì¹­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', Object.keys(STATION_MATCHING_DATA).length, 'ê°œ ì¡°ì„ê´€ì¸¡ì†Œ');
            } catch (error) {
                console.error('ë§¤ì¹­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ë§¤ì¹­ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. station_matching_top10.json íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        function populateTideStationSelect() {
            const select = document.getElementById('tideStationSelect');

            for (const [code, data] of Object.entries(STATION_MATCHING_DATA)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${data.tide_station_name}`;
                select.appendChild(option);
            }
        }

        async function analyzeAndMatch() {
            const tideStationCode = document.getElementById('tideStationSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ìƒíƒœ ë³€ê²½
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';

            try {
                // ì²˜ë¦¬í•  ì¡°ì„ê´€ì¸¡ì†Œ ëª©ë¡
                const stationsToProcess = tideStationCode === 'all'
                    ? Object.keys(STATION_MATCHING_DATA)
                    : [tideStationCode];

                analysisResults = {};

                for (const stationCode of stationsToProcess) {
                    const matchingData = STATION_MATCHING_DATA[stationCode];

                    // abs_fetch_logì—ì„œ ë°ì´í„° ë¶„ì„
                    const analysis = await analyzeAbsFetchLog(
                        matchingData.nearest_marine_stations,
                        startDate,
                        endDate
                    );

                    analysisResults[stationCode] = {
                        ...matchingData,
                        fieldRecommendations: analysis
                    };
                }

                // ê²°ê³¼ í‘œì‹œ
                displayResults();

            } catch (error) {
                console.error('ë¶„ì„ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        async function analyzeAbsFetchLog(marineStations, startDate, endDate) {
            const fields = ['wt', 'swh', 'wd', 'ws', 'at'];
            const fieldNames = {
                wt: 'ìˆ˜ì˜¨ (Water Temperature)',
                swh: 'íŒŒê³  (Significant Wave Height)',
                wd: 'í’í–¥ (Wind Direction)',
                ws: 'í’ì† (Wind Speed)',
                at: 'ê¸°ì˜¨ (Air Temperature)'
            };

            const recommendations = {};

            for (const field of fields) {
                // í•´ë‹¹ í•„ë“œë¥¼ ì œê³µí•˜ëŠ” ê´€ì¸¡ì†Œë§Œ í•„í„°
                const candidateStations = marineStations.filter(station =>
                    station.provides.includes(field)
                );

                const stationStats = [];

                // ê° ê´€ì¸¡ì†Œë³„ë¡œ abs_fetch_log ë°ì´í„° ë¶„ì„
                for (const station of candidateStations) {
                    const stats = await getStationStats(station.station_id, field, startDate, endDate);
                    stationStats.push({
                        ...station,
                        stats: stats
                    });
                }

                // ë°ì´í„° í’ˆì§ˆ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                // 1. ìœ íš¨ ë°ì´í„° ë¹„ìœ¨ (valid_ratio)
                // 2. í‰ê·  ìˆ˜ì§‘ ê°„ê²© (avg_interval)
                // 3. ê±°ë¦¬ (distance_km)
                stationStats.sort((a, b) => {
                    if (b.stats.valid_ratio !== a.stats.valid_ratio) {
                        return b.stats.valid_ratio - a.stats.valid_ratio;
                    }
                    if (a.stats.avg_interval !== b.stats.avg_interval) {
                        return a.stats.avg_interval - b.stats.avg_interval;
                    }
                    return a.distance_km - b.distance_km;
                });

                // ìƒìœ„ 2ê°œ ì¶”ì²œ
                recommendations[field] = {
                    field_name: fieldNames[field],
                    candidates: stationStats.slice(0, 2)
                };
            }

            return recommendations;
        }

        async function getStationStats(stationId, field, startDate, endDate) {
            try {
                // observation_time_kst í˜•ì‹: YYYYMMDDHHMM
                const startDateStr = startDate.replace(/-/g, '') + '0000';
                const endDateStr = endDate.replace(/-/g, '') + '2359';

                // í•„ë“œëª… ë§¤í•‘ (ë‚´ë¶€ í‚¤ â†’ marine_observations ì»¬ëŸ¼ëª…)
                const fieldMapping = {
                    'wt': 'water_temperature',
                    'swh': 'significant_wave_height',
                    'wd': 'wind_direction',
                    'ws': 'wind_speed',
                    'at': 'air_temperature'
                };

                const dbFieldName = fieldMapping[field];
                if (!dbFieldName) {
                    throw new Error(`Unknown field: ${field}`);
                }

                // Paginationìœ¼ë¡œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (1000ê°œ ì œí•œ íšŒí”¼)
                let allData = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('marine_observations')
                        .select('observation_time_kst, ' + dbFieldName)
                        .eq('station_id', stationId)
                        .gte('observation_time_kst', startDateStr)
                        .lte('observation_time_kst', endDateStr)
                        .order('observation_time_kst', { ascending: true })
                        .range(from, from + batchSize - 1);

                    if (error) throw error;

                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                    }

                    if (!data || data.length < batchSize) {
                        hasMore = false;
                    } else {
                        from += batchSize;
                    }
                }

                const data = allData;

                if (!data || data.length === 0) {
                    return {
                        total_records: 0,
                        valid_records: 0,
                        valid_ratio: 0,
                        avg_interval: null,
                        data_quality: 'ë°ì´í„° ì—†ìŒ'
                    };
                }

                // ìœ íš¨í•œ ë°ì´í„° ê°œìˆ˜ (nullì´ ì•„ë‹Œ ê°’)
                const validRecords = data.filter(row => row[dbFieldName] !== null && row[dbFieldName] !== '').length;
                const validRatio = (validRecords / data.length * 100).toFixed(1);

                // í‰ê·  ìˆ˜ì§‘ ê°„ê²© ê³„ì‚° (ë¶„ ë‹¨ìœ„)
                let avgInterval = null;
                if (data.length > 1) {
                    const intervals = [];
                    for (let i = 1; i < data.length; i++) {
                        const prevTime = parseObservationTime(data[i-1].observation_time_kst);
                        const currTime = parseObservationTime(data[i].observation_time_kst);
                        const diff = (currTime - prevTime) / (1000 * 60); // ë¶„ ë‹¨ìœ„
                        intervals.push(diff);
                    }
                    avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
                }

                // ë°ì´í„° í’ˆì§ˆ í‰ê°€
                let dataQuality = 'ìš°ìˆ˜';
                if (validRatio < 50) dataQuality = 'ë¶ˆëŸ‰';
                else if (validRatio < 80) dataQuality = 'ë³´í†µ';

                return {
                    total_records: data.length,
                    valid_records: validRecords,
                    valid_ratio: parseFloat(validRatio),
                    avg_interval: avgInterval,
                    data_quality: dataQuality
                };

            } catch (error) {
                console.error(`ê´€ì¸¡ì†Œ ${stationId} í†µê³„ ì¡°íšŒ ì‹¤íŒ¨:`, error);
                return {
                    total_records: 0,
                    valid_records: 0,
                    valid_ratio: 0,
                    avg_interval: null,
                    data_quality: 'ì¡°íšŒ ì‹¤íŒ¨'
                };
            }
        }

        function parseObservationTime(timeStr) {
            // YYYYMMDDHHMM -> Date ê°ì²´
            const year = parseInt(timeStr.substring(0, 4));
            const month = parseInt(timeStr.substring(4, 6)) - 1;
            const day = parseInt(timeStr.substring(6, 8));
            const hour = parseInt(timeStr.substring(8, 10));
            const minute = parseInt(timeStr.substring(10, 12));
            return new Date(year, month, day, hour, minute);
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            container.style.display = 'block';

            for (const [stationCode, data] of Object.entries(analysisResults)) {
                const card = createStationCard(stationCode, data);
                container.appendChild(card);

                // ì²« ë²ˆì§¸ í›„ë³´ë¥¼ ìë™ ì„ íƒ
                autoSelectFirstCandidates(stationCode, data);
            }

            // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
            document.getElementById('previewSection').style.display = 'block';
            updatePreviewTable();
        }

        function autoSelectFirstCandidates(stationCode, data) {
            // ê° í•„ë“œë³„ë¡œ ì²« ë²ˆì§¸ í›„ë³´ë¥¼ ìë™ ì„ íƒ
            for (const [fieldKey, fieldData] of Object.entries(data.fieldRecommendations)) {
                if (fieldData.candidates && fieldData.candidates.length > 0) {
                    const firstCandidate = fieldData.candidates[0];
                    const recId = `rec-${stationCode}-${fieldKey}-0`;

                    // ì„ íƒ ìƒíƒœ ì„¤ì •
                    if (!selectedMappings[stationCode]) {
                        selectedMappings[stationCode] = {};
                    }
                    selectedMappings[stationCode][fieldKey] = firstCandidate.station_id;

                    // UI ì—…ë°ì´íŠ¸ëŠ” ë‚˜ì¤‘ì— DOMì´ ë Œë”ë§ëœ í›„ ì‹¤í–‰
                    setTimeout(() => {
                        const recCard = document.getElementById(recId);
                        if (recCard) {
                            recCard.classList.add('selected');
                            const btn = recCard.querySelector('.select-btn');
                            if (btn) {
                                btn.textContent = 'ì„ íƒë¨';
                                btn.classList.add('selected');
                            }
                        }
                    }, 100);
                }
            }
        }

        function createStationCard(stationCode, data) {
            const card = document.createElement('div');
            card.className = 'station-card';
            card.id = `station-${stationCode}`;

            let html = `
                <div class="station-header">
                    <div>
                        <div class="station-title">${stationCode} - ${data.tide_station_name}</div>
                        <div class="station-info">
                            ìœ„ì¹˜: ${data.tide_station_lat.toFixed(4)}, ${data.tide_station_lon.toFixed(4)} |
                            í•´ì—­: ${data.marine_reg_name}
                        </div>
                    </div>
                </div>
            `;

            // ê° í•„ë“œë³„ ì¶”ì²œ
            for (const [fieldKey, fieldData] of Object.entries(data.fieldRecommendations)) {
                html += `
                    <div class="field-section">
                        <div class="field-title">ğŸ“Š ${fieldData.field_name}</div>
                `;

                fieldData.candidates.forEach((candidate, index) => {
                    const recId = `rec-${stationCode}-${fieldKey}-${index}`;
                    const stats = candidate.stats;

                    html += `
                        <div class="recommendation-card" id="${recId}">
                            <div class="rec-header">
                                <div>
                                    <span class="rec-name">${candidate.name} (${candidate.station_id})</span>
                                    <span style="color: #666; font-size: 14px; margin-left: 10px;">
                                        ${candidate.distance_km}km
                                    </span>
                                </div>
                                <button class="select-btn" onclick="selectRecommendation('${stationCode}', '${fieldKey}', ${index}, '${recId}')">
                                    ì„ íƒ
                                </button>
                            </div>
                            <div class="rec-stats">
                                <div class="stat-item">
                                    <div class="stat-label">ì „ì²´ ë ˆì½”ë“œ</div>
                                    <div class="stat-value">${stats.total_records}ê±´</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ìœ íš¨ ë°ì´í„°</div>
                                    <div class="stat-value">${stats.valid_records}ê±´ (${stats.valid_ratio}%)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">í‰ê·  ìˆ˜ì§‘ ì£¼ê¸°</div>
                                    <div class="stat-value">${stats.avg_interval ? stats.avg_interval + 'ë¶„' : 'N/A'}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">ë°ì´í„° í’ˆì§ˆ</div>
                                    <div class="stat-value">${stats.data_quality}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            card.innerHTML = html;
            return card;
        }

        // ì„ íƒëœ ë§¤ì¹­ ì •ë³´ ì €ì¥
        const selectedMappings = {};

        function selectRecommendation(stationCode, fieldKey, candidateIndex, recId) {
            // í•´ë‹¹ í•„ë“œì˜ ë‹¤ë¥¸ ì„ íƒ í•´ì œ
            const fieldSection = document.getElementById(recId).closest('.field-section');
            fieldSection.querySelectorAll('.recommendation-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.select-btn').textContent = 'ì„ íƒ';
                card.querySelector('.select-btn').classList.remove('selected');
            });

            // í˜„ì¬ ì„ íƒ í™œì„±í™”
            const recCard = document.getElementById(recId);
            recCard.classList.add('selected');
            const btn = recCard.querySelector('.select-btn');
            btn.textContent = 'ì„ íƒë¨';
            btn.classList.add('selected');

            // ì„ íƒ ì •ë³´ ì €ì¥
            if (!selectedMappings[stationCode]) {
                selectedMappings[stationCode] = {};
            }

            const candidate = analysisResults[stationCode].fieldRecommendations[fieldKey].candidates[candidateIndex];
            selectedMappings[stationCode][fieldKey] = candidate.station_id;

            updatePreviewTable();
        }

        function updateUploadSummary() {
            const totalStations = Object.keys(analysisResults).length;
            const mappedStations = Object.keys(selectedMappings).length;

            const summary = document.getElementById('uploadSummary');
            summary.innerHTML = `
                <strong>ë§¤ì¹­ í˜„í™©:</strong> ${mappedStations} / ${totalStations} ê°œ ì¡°ì„ê´€ì¸¡ì†Œ<br>
                <small>ê° ì¡°ì„ê´€ì¸¡ì†Œë§ˆë‹¤ 5ê°œ í•„ë“œ(wt, swh, wd, ws, at)ì˜ í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</small>
            `;
        }

        function updatePreviewTable() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            const summary = document.getElementById('previewSummary');
            const totalStations = Object.keys(analysisResults).length;
            const mappedStations = Object.keys(selectedMappings).length;

            summary.innerHTML = `
                <strong>ë§¤ì¹­ í˜„í™©:</strong> ${mappedStations} / ${totalStations} ê°œ ì¡°ì„ê´€ì¸¡ì†Œ<br>
                <small>ì•„ë˜ í…Œì´ë¸”ì„ í™•ì¸í•˜ê³  ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ê±°ë‚˜ Supabaseì— ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
            `;

            // ì •ë ¬ëœ ì¡°ì„ê´€ì¸¡ì†Œ ëª©ë¡ ìƒì„±
            const sortedStations = Object.keys(analysisResults).sort();

            for (const stationCode of sortedStations) {
                const data = analysisResults[stationCode];
                const mappings = selectedMappings[stationCode] || {};

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';

                // ì¡°ì„ê´€ì¸¡ì†Œ ì½”ë“œ
                const codeCell = document.createElement('td');
                codeCell.style.padding = '10px';
                codeCell.style.border = '1px solid #ddd';
                codeCell.textContent = stationCode;
                row.appendChild(codeCell);

                // ì¡°ì„ê´€ì¸¡ì†Œëª…
                const nameCell = document.createElement('td');
                nameCell.style.padding = '10px';
                nameCell.style.border = '1px solid #ddd';
                nameCell.textContent = data.tide_station_name;
                row.appendChild(nameCell);

                // ê° í•„ë“œë³„ ì„ íƒëœ ê´€ì¸¡ì†Œ ID
                const fields = ['wt', 'swh', 'wd', 'ws', 'at'];
                for (const field of fields) {
                    const fieldCell = document.createElement('td');
                    fieldCell.style.padding = '10px';
                    fieldCell.style.border = '1px solid #ddd';
                    fieldCell.style.textAlign = 'center';

                    if (mappings[field]) {
                        // ì„ íƒëœ ê´€ì¸¡ì†Œ ì •ë³´ ì°¾ê¸°
                        const candidates = data.fieldRecommendations[field]?.candidates || [];
                        const selected = candidates.find(c => c.station_id === mappings[field]);

                        if (selected) {
                            fieldCell.innerHTML = `
                                <strong>${selected.station_id}</strong><br>
                                <small style="color: #666;">${selected.name}</small>
                            `;
                        } else {
                            fieldCell.textContent = mappings[field];
                        }
                    } else {
                        fieldCell.innerHTML = '<span style="color: #ccc;">ë¯¸ì„ íƒ</span>';
                    }

                    row.appendChild(fieldCell);
                }

                tbody.appendChild(row);
            }
        }

        function downloadExcel() {
            if (Object.keys(selectedMappings).length === 0) {
                alert('ì„ íƒëœ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì—‘ì…€ ë°ì´í„° ìƒì„±
            const excelData = [];

            // í—¤ë”
            excelData.push([
                'ì¡°ì„ê´€ì¸¡ì†Œ ì½”ë“œ',
                'ì¡°ì„ê´€ì¸¡ì†Œëª…',
                'ìˆ˜ì˜¨(wt) ê´€ì¸¡ì†ŒID',
                'ìˆ˜ì˜¨(wt) ê´€ì¸¡ì†Œëª…',
                'íŒŒê³ (swh) ê´€ì¸¡ì†ŒID',
                'íŒŒê³ (swh) ê´€ì¸¡ì†Œëª…',
                'í’í–¥(wd) ê´€ì¸¡ì†ŒID',
                'í’í–¥(wd) ê´€ì¸¡ì†Œëª…',
                'í’ì†(ws) ê´€ì¸¡ì†ŒID',
                'í’ì†(ws) ê´€ì¸¡ì†Œëª…',
                'ê¸°ì˜¨(at) ê´€ì¸¡ì†ŒID',
                'ê¸°ì˜¨(at) ê´€ì¸¡ì†Œëª…'
            ]);

            // ë°ì´í„° í–‰
            const sortedStations = Object.keys(analysisResults).sort();

            for (const stationCode of sortedStations) {
                const data = analysisResults[stationCode];
                const mappings = selectedMappings[stationCode] || {};

                const row = [
                    stationCode,
                    data.tide_station_name
                ];

                const fields = ['wt', 'swh', 'wd', 'ws', 'at'];
                for (const field of fields) {
                    if (mappings[field]) {
                        const candidates = data.fieldRecommendations[field]?.candidates || [];
                        const selected = candidates.find(c => c.station_id === mappings[field]);

                        if (selected) {
                            row.push(selected.station_id);
                            row.push(selected.name);
                        } else {
                            row.push(mappings[field]);
                            row.push('');
                        }
                    } else {
                        row.push('');
                        row.push('');
                    }
                }

                excelData.push(row);
            }

            // SheetJSë¡œ ì—‘ì…€ íŒŒì¼ ìƒì„±
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 15 }, // ì¡°ì„ê´€ì¸¡ì†Œ ì½”ë“œ
                { wch: 15 }, // ì¡°ì„ê´€ì¸¡ì†Œëª…
                { wch: 15 }, // wt ID
                { wch: 15 }, // wt ëª…
                { wch: 15 }, // swh ID
                { wch: 15 }, // swh ëª…
                { wch: 15 }, // wd ID
                { wch: 15 }, // wd ëª…
                { wch: 15 }, // ws ID
                { wch: 15 }, // ws ëª…
                { wch: 15 }, // at ID
                { wch: 15 }  // at ëª…
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ì¡°ì„-í•´ì–‘ ê´€ì¸¡ì†Œ ë§¤ì¹­');

            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            const today = new Date().toISOString().split('T')[0];
            const filename = `tide_marine_station_matching_${today}.xlsx`;
            XLSX.writeFile(wb, filename);

            console.log('ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ:', filename);
        }

        async function uploadToSupabase() {
            if (Object.keys(selectedMappings).length === 0) {
                alert('ì„ íƒëœ ë§¤ì¹­ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!confirm(`${Object.keys(selectedMappings).length}ê°œ ì¡°ì„ê´€ì¸¡ì†Œì˜ ë§¤ì¹­ ì •ë³´ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            try {
                const updates = [];

                for (const [stationCode, fieldMappings] of Object.entries(selectedMappings)) {
                    const updateData = {
                        wt_STN_ID: fieldMappings.wt || null,
                        swh_STN_ID: fieldMappings.swh || null,
                        wd_STN_ID: fieldMappings.wd || null,
                        ws_STN_ID: fieldMappings.ws || null,
                        at_STN_ID: fieldMappings.at || null
                    };

                    const { error } = await supabaseClient
                        .from('tide_abs_region')
                        .update(updateData)
                        .eq('Code', stationCode);

                    if (error) throw error;

                    updates.push(stationCode);
                }

                alert(`âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n${updates.length}ê°œ ì¡°ì„ê´€ì¸¡ì†Œì˜ í•´ì–‘ê´€ì¸¡ì†Œ ë§¤ì¹­ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
