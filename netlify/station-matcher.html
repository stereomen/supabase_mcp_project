<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ì¸¡ì†Œ ë§¤ì¹­ ë„êµ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            text-align: center;
            position: relative;
        }
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
        }
        .back-button {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
        }
        .content {
            padding: 30px;
        }
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e9ecef;
        }
        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 15px;
        }
        .upload-text {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: #d1ecf1;
            border-radius: 10px;
            display: none;
        }
        .file-info.show {
            display: block;
        }
        input[type="file"] {
            display: none;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .info-card-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .info-card-label {
            color: #666;
            font-size: 0.9em;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            max-height: 600px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
            font-size: 0.85em;
        }
        td {
            padding: 10px 8px;
            border-bottom: 1px solid #e0e0e0;
            white-space: nowrap;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
            display: none;
        }
        .loading.show {
            display: block;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .error.show {
            display: block;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .success.show {
            display: block;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        .column-header {
            background: #495057;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-button">â† ëŒ€ì‹œë³´ë“œ</a>
            <h1>ğŸ—ºï¸ í•´ì–‘/ì¡°ì„ ê´€ì¸¡ì†Œ ë§¤ì¹­ ë„êµ¬</h1>
            <p>ìœ„ë„/ê²½ë„ ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ê°€ê¹Œìš´ í•´ì–‘ê´€ì¸¡ì†Œë¥¼ ìë™ ë§¤ì¹­í•©ë‹ˆë‹¤</p>
        </div>

        <div class="content">
            <!-- íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="section">
                <h2>ğŸ“¤ 1ë‹¨ê³„: ì¡°ì„ ê´€ì¸¡ì†Œ CSV íŒŒì¼ ì—…ë¡œë“œ</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</div>
                    <div style="font-size: 0.9em; color: #999; margin-top: 10px;">
                        í•„ìˆ˜ ì»¬ëŸ¼: code, obsPostName, ìœ„ë„, ê²½ë„
                    </div>
                    <div style="font-size: 0.85em; color: #667eea; margin-top: 8px; font-weight: 500;">
                        ğŸ’¡ supabaseì— Files>Buckets>region ê²½ë¡œì— tide_abs_region_rows.csv íŒŒì¼ì„ ì´ìš©í•©ë‹ˆë‹¤.
                    </div>
                    <input type="file" id="fileInput" accept=".csv">
                </div>
                <div class="file-info" id="fileInfo">
                    <strong>ì—…ë¡œë“œëœ íŒŒì¼:</strong> <span id="fileName"></span><br>
                    <strong>ë ˆì½”ë“œ ìˆ˜:</strong> <span id="recordCount"></span>
                </div>
            </div>

            <!-- ë°ì´í„° ì†ŒìŠ¤ ì •ë³´ -->
            <div class="section">
                <h2>ğŸ“Š 2ë‹¨ê³„: í•´ì–‘ê´€ì¸¡ì†Œ ë°ì´í„° ë¡œë“œ</h2>
                <p style="color: #666; margin-bottom: 15px;">
                    abs_fetch_log í…Œì´ë¸”ì„ ë¶„ì„í•˜ì—¬ ì»¤ë²„ë¦¬ì§€ 100%ì¸ ì§€ì ë“¤ì„ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤.
                </p>
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-value" id="stationsACount">-</div>
                        <div class="info-card-label">íŒŒê³ +ìˆ˜ì˜¨ ì»¤ë²„ë¦¬ì§€ 100% ì§€ì </div>
                    </div>
                    <div class="info-card">
                        <div class="info-card-value" id="stationsBCount">-</div>
                        <div class="info-card-label">ê¸°ì˜¨+í’í–¥+í’ì† ì»¤ë²„ë¦¬ì§€ 100% ì§€ì </div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="loadStationData()" id="loadBtn">
                        í…Œì´ë¸” ë¶„ì„ ë° ë°ì´í„° ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- ë§¤ì¹­ ì‹¤í–‰ -->
            <div class="section">
                <h2>âš™ï¸ 3ë‹¨ê³„: ë§¤ì¹­ ì‹¤í–‰</h2>
                <div class="actions">
                    <button class="btn btn-primary" onclick="runMatching()" id="matchBtn" disabled>
                        ë§¤ì¹­ ì‹¤í–‰
                    </button>
                    <button class="btn btn-success" onclick="downloadCSV()" id="downloadBtn" disabled>
                        ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn btn-primary" onclick="uploadToSupabase()" id="uploadBtn" disabled style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        ğŸ“¤ Supabase ì—…ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- ì„±ê³µ ë©”ì‹œì§€ -->
            <div id="successMessage" class="success"></div>

            <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
            <div id="errorMessage" class="error"></div>

            <!-- ë¡œë”© í‘œì‹œ -->
            <div id="loading" class="loading">
                ë§¤ì¹­ì„ ì‹¤í–‰í•˜ëŠ” ì¤‘...
            </div>

            <!-- ê²°ê³¼ í…Œì´ë¸” -->
            <div class="section">
                <h2>ğŸ“‹ 4ë‹¨ê³„: ë§¤ì¹­ ê²°ê³¼</h2>
                <div class="table-container">
                    <table id="resultTable">
                        <thead>
                            <tr>
                                <th colspan="8" style="background: #495057;">ì¡°ì„ ê´€ì¸¡ì†Œ ì •ë³´</th>
                                <th colspan="5" class="column-header">íŒŒê³ +ìˆ˜ì˜¨ ë³´ìœ  ì§€ì  (A)</th>
                                <th colspan="5" class="column-header">ê¸°ì˜¨+í’í–¥+í’ì† ë³´ìœ  ì§€ì  (B)</th>
                            </tr>
                            <tr>
                                <th>ì½”ë“œ</th>
                                <th>ê´€ì¸¡ì†Œëª…</th>
                                <th>ìœ„ë„</th>
                                <th>ê²½ë„</th>
                                <th>í•´ì—­</th>
                                <th>ì£¼ì†Œ(ì‹œë„)</th>
                                <th>ì£¼ì†Œ(ì‹œêµ°êµ¬)</th>
                                <th>ì£¼ì†Œ(ìƒì„¸)</th>
                                <th class="column-header">ì§€ì—­ëª…</th>
                                <th class="column-header">STN ID</th>
                                <th class="column-header">ìœ„ë„</th>
                                <th class="column-header">ê²½ë„</th>
                                <th class="column-header">ê±°ë¦¬</th>
                                <th class="column-header">ì§€ì—­ëª…</th>
                                <th class="column-header">STN ID</th>
                                <th class="column-header">ìœ„ë„</th>
                                <th class="column-header">ê²½ë„</th>
                                <th class="column-header">ê±°ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="18" class="empty-state">
                                    <div class="empty-state-icon">ğŸ”</div>
                                    <div>ì¡°ì„ ê´€ì¸¡ì†Œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë§¤ì¹­ì„ ì‹¤í–‰í•˜ì„¸ìš”</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://iwpgvdtfpwazzfeniusk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml3cGd2ZHRmcHdhenpmZW5pdXNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwNzEzOTQsImV4cCI6MjA2NjY0NzM5NH0.d0pjIvnOdPGbc_-cfqRNu9yOIutyO1eex848k1yNZJE';

        let tideStations = [];
        let absStationsA = [];
        let absStationsB = [];
        let matchingResults = [];

        // ìœ í´ë¦¬ë“œ ê±°ë¦¬ ê³„ì‚°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            if (typeof lat1 !== 'number' || typeof lon1 !== 'number' ||
                typeof lat2 !== 'number' || typeof lon2 !== 'number') {
                return Infinity;
            }
            return Math.sqrt(Math.pow(lat1 - lat2, 2) + Math.pow(lon1 - lon2, 2));
        }

        // CSV íŒŒì‹±
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const results = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index];
                });
                results.push(row);
            }

            return results;
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');

            if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    tideStations = parseCSV(e.target.result);

                    // í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                    if (tideStations.length === 0) {
                        showError('CSV íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const requiredColumns = ['code', 'obsPostName', 'ìœ„ë„', 'ê²½ë„'];
                    const firstRow = tideStations[0];
                    const missingColumns = requiredColumns.filter(col => !(col in firstRow));

                    if (missingColumns.length > 0) {
                        showError(`í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${missingColumns.join(', ')}`);
                        return;
                    }

                    // ìœ„ë„/ê²½ë„ë¥¼ ìˆ«ìë¡œ ë³€í™˜
                    tideStations.forEach(station => {
                        station.lat = parseFloat(station['ìœ„ë„']);
                        station.lon = parseFloat(station['ê²½ë„']);
                    });

                    document.getElementById('fileName').textContent = file.name;
                    document.getElementById('recordCount').textContent = tideStations.length;
                    document.getElementById('fileInfo').classList.add('show');

                    hideError();
                } catch (error) {
                    showError('CSV íŒŒì¼ íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file, 'utf-8');
        }

        // í•´ì–‘ê´€ì¸¡ì†Œ ë°ì´í„° ë¡œë“œ (Supabase abs_fetch_log í…Œì´ë¸” ë¶„ì„)
        async function loadStationData() {
            try {
                document.getElementById('loadBtn').disabled = true;
                document.getElementById('loading').classList.add('show');

                // abs_fetch_log í…Œì´ë¸”ì—ì„œ ëª¨ë“  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ë„¤ì´ì…˜)
                let allData = [];
                let offset = 0;
                const limit = 1000;
                let hasMore = true;

                console.log('abs_fetch_log í…Œì´ë¸” ë°ì´í„° ë¡œë“œ ì‹œì‘...');

                while (hasMore) {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/abs_fetch_log?select=*&limit=${limit}&offset=${offset}`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    allData = allData.concat(data);
                    console.log(`- ë°°ì¹˜ ${Math.floor(offset / limit) + 1}: ${data.length}ê°œ, ëˆ„ì : ${allData.length}ê°œ`);

                    if (data.length < limit) {
                        hasMore = false;
                    } else {
                        offset += limit;
                    }
                }

                console.log(`ì´ ${allData.length}ê°œ ë ˆì½”ë“œ ë¡œë“œ ì™„ë£Œ`);
                const data = allData;

                // ì§€ì ë³„ë¡œ ì»¤ë²„ë¦¬ì§€ ë¶„ì„
                const stationMap = {};

                data.forEach(row => {
                    const key = `${row.station_id}_${row.observation_type}`;

                    if (!stationMap[key]) {
                        stationMap[key] = {
                            station_id: row.station_id,
                            station_name: row.station_name,
                            observation_type: row.observation_type,
                            latitude: row.latitude,
                            longitude: row.longitude,
                            totalCount: 0,
                            // A ì§€ì : íŒŒê³  + ìˆ˜ì˜¨
                            waveHeightCount: 0,
                            waterTempCount: 0,
                            // B ì§€ì : ê¸°ì˜¨ + í’í–¥ + í’ì†
                            airTempCount: 0,
                            windDirectionCount: 0,
                            windSpeedCount: 0
                        };
                    }

                    const station = stationMap[key];
                    station.totalCount++;

                    // ê° ë°ì´í„° í•­ëª©ì´ ìˆëŠ” ê²½ìš° ì¹´ìš´íŠ¸
                    if (row.significant_wave_height_available) station.waveHeightCount++;
                    if (row.water_temperature_available) station.waterTempCount++;
                    if (row.air_temperature_available) station.airTempCount++;
                    if (row.wind_direction_available) station.windDirectionCount++;
                    if (row.wind_speed_available) station.windSpeedCount++;
                });

                // A ì§€ì : íŒŒê³  + ìˆ˜ì˜¨ ì»¤ë²„ë¦¬ì§€ 100%ì¸ ì§€ì 
                absStationsA = [];
                // B ì§€ì : ê¸°ì˜¨ + í’í–¥ + í’ì† ì»¤ë²„ë¦¬ì§€ 100%ì¸ ì§€ì 
                absStationsB = [];

                Object.values(stationMap).forEach(station => {
                    if (station.totalCount === 0) return;

                    // A ì§€ì : íŒŒê³ ì™€ ìˆ˜ì˜¨ì´ ëª¨ë‘ 100%
                    const waveHeightCoverage = (station.waveHeightCount / station.totalCount) * 100;
                    const waterTempCoverage = (station.waterTempCount / station.totalCount) * 100;

                    if (waveHeightCoverage === 100 && waterTempCoverage === 100) {
                        absStationsA.push({
                            'ì§€ì—­ëª…(í•œê¸€)': station.station_name,
                            'STN ID': station.station_id,
                            'ìœ„ë„(LAT)': station.latitude,
                            'ê²½ë„(LON)': station.longitude,
                            lat: station.latitude,
                            lon: station.longitude,
                            observation_type: station.observation_type
                        });
                    }

                    // B ì§€ì : ê¸°ì˜¨, í’í–¥, í’ì†ì´ ëª¨ë‘ 100%
                    const airTempCoverage = (station.airTempCount / station.totalCount) * 100;
                    const windDirectionCoverage = (station.windDirectionCount / station.totalCount) * 100;
                    const windSpeedCoverage = (station.windSpeedCount / station.totalCount) * 100;

                    if (airTempCoverage === 100 && windDirectionCoverage === 100 && windSpeedCoverage === 100) {
                        absStationsB.push({
                            'ì§€ì—­ëª…(í•œê¸€)': station.station_name,
                            'STN ID': station.station_id,
                            'ìœ„ë„(LAT)': station.latitude,
                            'ê²½ë„(LON)': station.longitude,
                            lat: station.latitude,
                            lon: station.longitude,
                            observation_type: station.observation_type
                        });
                    }
                });

                document.getElementById('stationsACount').textContent = absStationsA.length;
                document.getElementById('stationsBCount').textContent = absStationsB.length;

                // ë§¤ì¹­ ë²„íŠ¼ í™œì„±í™” (ì¡°ì„ ë°ì´í„°ê°€ ë¡œë“œë˜ì–´ ìˆì„ ë•Œë§Œ)
                if (tideStations.length > 0) {
                    document.getElementById('matchBtn').disabled = false;
                }

                hideError();
            } catch (error) {
                showError('í•´ì–‘ê´€ì¸¡ì†Œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                document.getElementById('loadBtn').disabled = false;
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        // ë§¤ì¹­ ì‹¤í–‰
        function runMatching() {
            if (tideStations.length === 0) {
                showError('ì¡°ì„ ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            if (absStationsA.length === 0 || absStationsB.length === 0) {
                showError('í•´ì–‘ê´€ì¸¡ì†Œ ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”.');
                return;
            }

            document.getElementById('loading').classList.add('show');
            document.getElementById('matchBtn').disabled = true;

            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì‹¤í–‰ (UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
            setTimeout(() => {
                try {
                    matchingResults = [];

                    tideStations.forEach(tide => {
                        // ê°€ì¥ ê°€ê¹Œìš´ A ì§€ì  ì°¾ê¸°
                        let closestA = null;
                        let minDistanceA = Infinity;

                        absStationsA.forEach(abs => {
                            const distance = calculateDistance(tide.lat, tide.lon, abs.lat, abs.lon);
                            if (distance < minDistanceA) {
                                minDistanceA = distance;
                                closestA = abs;
                            }
                        });

                        // ê°€ì¥ ê°€ê¹Œìš´ B ì§€ì  ì°¾ê¸°
                        let closestB = null;
                        let minDistanceB = Infinity;

                        absStationsB.forEach(abs => {
                            const distance = calculateDistance(tide.lat, tide.lon, abs.lat, abs.lon);
                            if (distance < minDistanceB) {
                                minDistanceB = distance;
                                closestB = abs;
                            }
                        });

                        matchingResults.push({
                            tide: tide,
                            closestA: closestA,
                            distanceA: minDistanceA,
                            closestB: closestB,
                            distanceB: minDistanceB
                        });
                    });

                    renderResults();
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('uploadBtn').disabled = false;
                    hideError();
                } catch (error) {
                    showError('ë§¤ì¹­ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    document.getElementById('loading').classList.remove('show');
                    document.getElementById('matchBtn').disabled = false;
                }
            }, 100);
        }

        // ê²°ê³¼ ë Œë”ë§
        function renderResults() {
            const tbody = document.getElementById('tableBody');

            if (matchingResults.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" class="empty-state"><div class="empty-state-icon">ğŸ”</div><div>ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                return;
            }

            tbody.innerHTML = matchingResults.map(result => {
                const tide = result.tide;
                const a = result.closestA;
                const b = result.closestB;

                return `
                    <tr>
                        <td>${tide.code || '-'}</td>
                        <td>${tide.obsPostName || '-'}</td>
                        <td>${tide.lat.toFixed(6)}</td>
                        <td>${tide.lon.toFixed(6)}</td>
                        <td>${tide.marine_reg_name || '-'}</td>
                        <td>${tide.AddressA || '-'}</td>
                        <td>${tide.AddressB || '-'}</td>
                        <td>${tide.AddressC || '-'}</td>
                        <td>${a ? a['ì§€ì—­ëª…(í•œê¸€)'] : '-'}</td>
                        <td>${a ? a['STN ID'] : '-'}</td>
                        <td>${a ? parseFloat(a['ìœ„ë„(LAT)']).toFixed(6) : '-'}</td>
                        <td>${a ? parseFloat(a['ê²½ë„(LON)']).toFixed(6) : '-'}</td>
                        <td>${result.distanceA !== Infinity ? result.distanceA.toFixed(6) : '-'}</td>
                        <td>${b ? b['ì§€ì—­ëª…(í•œê¸€)'] : '-'}</td>
                        <td>${b ? b['STN ID'] : '-'}</td>
                        <td>${b ? parseFloat(b['ìœ„ë„(LAT)']).toFixed(6) : '-'}</td>
                        <td>${b ? parseFloat(b['ê²½ë„(LON)']).toFixed(6) : '-'}</td>
                        <td>${result.distanceB !== Infinity ? result.distanceB.toFixed(6) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // CSV ë‹¤ìš´ë¡œë“œ
        function downloadCSV() {
            if (matchingResults.length === 0) {
                showError('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // CSV í—¤ë”
            const headers = [
                'code', 'obsPostName', 'ìœ„ë„', 'ê²½ë„', 'marine_reg_name',
                'AddressA', 'AddressB', 'AddressC',
                'a_ì§€ì—­ëª…(í•œê¸€)', 'a_STN ID', 'a_ìœ„ë„(LAT)', 'a_ê²½ë„(LON)', 'a_ê±°ë¦¬',
                'b_ì§€ì—­ëª…(í•œê¸€)', 'b_STN ID', 'b_ìœ„ë„(LAT)', 'b_ê²½ë„(LON)', 'b_ê±°ë¦¬'
            ];

            // CSV ë°ì´í„°
            const rows = matchingResults.map(result => {
                const tide = result.tide;
                const a = result.closestA;
                const b = result.closestB;

                return [
                    tide.code || '',
                    tide.obsPostName || '',
                    tide.lat || '',
                    tide.lon || '',
                    tide.marine_reg_name || '',
                    tide.AddressA || '',
                    tide.AddressB || '',
                    tide.AddressC || '',
                    a ? a['ì§€ì—­ëª…(í•œê¸€)'] : '',
                    a ? a['STN ID'] : '',
                    a ? a['ìœ„ë„(LAT)'] : '',
                    a ? a['ê²½ë„(LON)'] : '',
                    result.distanceA !== Infinity ? result.distanceA : '',
                    b ? b['ì§€ì—­ëª…(í•œê¸€)'] : '',
                    b ? b['STN ID'] : '',
                    b ? b['ìœ„ë„(LAT)'] : '',
                    b ? b['ê²½ë„(LON)'] : '',
                    result.distanceB !== Infinity ? result.distanceB : ''
                ].join(',');
            });

            // CSV ìƒì„±
            const csv = [headers.join(','), ...rows].join('\n');

            // BOM ì¶”ê°€ (Excelì—ì„œ í•œê¸€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const link = document.createElement('a');
            link.href = url;
            link.download = 'tide_abs_matched_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();

            URL.revokeObjectURL(url);
        }

        // Supabase ì—…ë¡œë“œ
        async function uploadToSupabase() {
            if (matchingResults.length === 0) {
                showError('ì—…ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‚¬ìš©ì í™•ì¸
            if (!confirm(`${matchingResults.length}ê°œì˜ ë°ì´í„°ë¥¼ tide_abs_region í…Œì´ë¸”ì— ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê¸°ì¡´ ë°ì´í„°ëŠ” upsert ë°©ì‹ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('loading').classList.add('show');

                // ë¨¼ì € í…Œì´ë¸”ì—ì„œ í•œ ê°œ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì„œ ì‹¤ì œ ì»¬ëŸ¼ëª… í™•ì¸
                const sampleResponse = await fetch(`${SUPABASE_URL}/rest/v1/tide_abs_region?select=*&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (sampleResponse.ok) {
                    const sampleData = await sampleResponse.json();
                    if (sampleData && sampleData.length > 0) {
                        console.log('ì‹¤ì œ í…Œì´ë¸” ì»¬ëŸ¼:', Object.keys(sampleData[0]));
                    }
                }

                // ë°ì´í„° ì¤€ë¹„ (ì‹¤ì œ í…Œì´ë¸” ìŠ¤í‚¤ë§ˆì— ë§ê²Œ)
                const dataToUpload = matchingResults.map(result => {
                    const tide = result.tide;
                    const a = result.closestA;
                    const b = result.closestB;

                    // ì‹¤ì œ í…Œì´ë¸” ì»¬ëŸ¼ëª…ì— ë§ê²Œ ë§¤í•‘ (Python CSVì™€ ë™ì¼)
                    const record = {
                        'Code': tide.code || null,
                        'Name': tide.obsPostName || null,
                        'Latitude': tide.lat || null,
                        'Longitude': tide.lon || null,
                        'a_ì§€ì—­ëª…(í•œê¸€)': a ? a['ì§€ì—­ëª…(í•œê¸€)'] : null,
                        'a_STN ID': a ? a['STN ID'] : null,
                        'a_ìœ„ë„(LAT)': a ? parseFloat(a['ìœ„ë„(LAT)']) : null,
                        'a_ê²½ë„(LON)': a ? parseFloat(a['ê²½ë„(LON)']) : null,
                        'a_ì œê³µ ì •ë³´': null,  // ë§¤ì¹­ ë°ì´í„°ì— ì—†ìœ¼ë¯€ë¡œ null
                        'b_ì§€ì—­ëª…(í•œê¸€)': b ? b['ì§€ì—­ëª…(í•œê¸€)'] : null,
                        'b_STN ID': b ? b['STN ID'] : null,
                        'b_ìœ„ë„(LAT)': b ? parseFloat(b['ìœ„ë„(LAT)']) : null,
                        'b_ê²½ë„(LON)': b ? parseFloat(b['ê²½ë„(LON)']) : null,
                        'b_ì œê³µ ì •ë³´': null  // ë§¤ì¹­ ë°ì´í„°ì— ì—†ìœ¼ë¯€ë¡œ null
                    };

                    // ë¹ˆ ë¬¸ìì—´ì„ nullë¡œ ë³€í™˜
                    Object.keys(record).forEach(key => {
                        if (record[key] === '') {
                            record[key] = null;
                        }
                    });

                    return record;
                });

                // Supabaseì— upsert
                const upsertResponse = await fetch(`${SUPABASE_URL}/rest/v1/tide_abs_region`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify(dataToUpload)
                });

                if (!upsertResponse.ok) {
                    const errorText = await upsertResponse.text();
                    throw new Error(`Upload failed: ${upsertResponse.status} - ${errorText}`);
                }

                showSuccess(`âœ… ${matchingResults.length}ê°œì˜ ë°ì´í„°ê°€ tide_abs_region í…Œì´ë¸”ì— ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                hideError();
            } catch (error) {
                showError('Supabase ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                console.error('Upload error:', error);
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            hideSuccess();
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.remove('show');
        }

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        function showSuccess(message) {
            hideError();
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.add('show');

            // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
            setTimeout(() => {
                hideSuccess();
            }, 5000);
        }

        function hideSuccess() {
            document.getElementById('successMessage').classList.remove('show');
        }

        // Supabase Storageì—ì„œ ê¸°ë³¸ ì¡°ì„ ê´€ì¸¡ì†Œ íŒŒì¼ ë¡œë“œ
        async function loadDefaultTideStationFile() {
            try {
                console.log('ê¸°ë³¸ ì¡°ì„ ê´€ì¸¡ì†Œ íŒŒì¼ ë¡œë“œ ì‹œì‘...');

                // Supabase Storageì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/public/region/tide_abs_region_rows.csv`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY
                    }
                });

                if (!response.ok) {
                    console.warn('ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ (Storageì— íŒŒì¼ì´ ì—†ì„ ìˆ˜ ìˆìŒ):', response.status);
                    return;
                }

                // í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
                const text = await response.text();

                // CSV íŒŒì‹±
                tideStations = parseCSV(text);

                // í•„ìˆ˜ ì»¬ëŸ¼ í™•ì¸
                if (tideStations.length === 0) {
                    console.warn('ê¸°ë³¸ CSV íŒŒì¼ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                const requiredColumns = ['code', 'obsPostName', 'ìœ„ë„', 'ê²½ë„'];
                const firstRow = tideStations[0];
                const missingColumns = requiredColumns.filter(col => !(col in firstRow));

                if (missingColumns.length > 0) {
                    console.warn(`ê¸°ë³¸ íŒŒì¼ì—ì„œ í•„ìˆ˜ ì»¬ëŸ¼ ëˆ„ë½: ${missingColumns.join(', ')}`);
                    tideStations = [];
                    return;
                }

                // ìœ„ë„/ê²½ë„ë¥¼ ìˆ«ìë¡œ ë³€í™˜
                tideStations.forEach(station => {
                    station.lat = parseFloat(station['ìœ„ë„']);
                    station.lon = parseFloat(station['ê²½ë„']);
                });

                // UI ì—…ë°ì´íŠ¸
                document.getElementById('fileName').textContent = 'tide_abs_region_rows.csv (ê¸°ë³¸ íŒŒì¼)';
                document.getElementById('recordCount').textContent = tideStations.length;
                document.getElementById('fileInfo').classList.add('show');

                console.log(`ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì™„ë£Œ: ${tideStations.length}ê°œ ë ˆì½”ë“œ`);
            } catch (error) {
                console.warn('ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ íŒŒì¼ ìë™ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadDefaultTideStationFile();
        });

        // iframe ì•ˆì—ì„œ ë¡œë“œë  ë•Œ í—¤ë”/ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        if (window.self !== window.top) {
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const backButtons = document.querySelectorAll('.back-button, a[href="/"], a[href="index.html"]');
            backButtons.forEach(btn => btn.style.display = 'none');

            // í—¤ë” ìˆ¨ê¸°ê¸° (ë‹¤ì–‘í•œ ì„ íƒì ì‹œë„)
            const headers = document.querySelectorAll('.header, .hero, header');
            headers.forEach(header => {
                // í—¤ë” ë‚´ìš©ì´ "ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°"ë§Œ ìˆëŠ” ê²½ìš° ì „ì²´ ìˆ¨ê¹€
                if (header.querySelector('.back-button')) {
                    header.style.display = 'none';
                }
            });

            // ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ì •ë¦¬
            const containers = document.querySelectorAll('.container, .dashboard');
            containers.forEach(container => {
                container.style.borderRadius = '0';
                container.style.boxShadow = 'none';
            });

            // body ë°°ê²½ ì •ë¦¬
            document.body.style.background = 'white';
            document.body.style.padding = '0';
            document.body.style.minHeight = 'auto';
        }

    </script>
</body>
</html>
